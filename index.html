<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0c2461">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Arena 2026">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">
    <!-- META TAG PWA -->
    <meta name="theme-color" content="#0c2461">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Arena 2026">
    <meta name="description" content="Gestione Campionato Arena 2026 - PWA">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Campionato Arena 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0c2461, #1e3799);
            min-height: 100vh;
            padding: 20px;
            padding-top: env(safe-area-inset-top, 0px);
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        .login-container {
            max-width: 500px;
            margin: 60px auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .logo {
            font-size: 2.5rem;
            color: #0c2461;
            margin-bottom: 10px;
        }
        
        .logo i {
            margin-right: 10px;
        }
        
        .tagline {
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .user-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .user-btn {
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #0c2461;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 44px;
        }
        
        .user-btn:hover {
            background: #0c2461;
            color: white;
            transform: translateY(-2px);
        }
        
        .admin-badge {
            background: #e74c3c;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .player-badge {
            background: #27ae60;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .password-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }
        
        .password-input {
            padding: 12px;
            width: 100%;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #0c2461;
        }
        
        .login-btn {
            padding: 12px;
            width: 100%;
            background: #0c2461;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 44px;
        }
        
        .login-btn:hover {
            background: #1e3799;
        }
        
        .error-msg {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .user-info-bar {
            background: linear-gradient(135deg, #0c2461, #1e3799);
            color: white;
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .current-user {
            background: #ffd700;
            color: #0c2461;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        
        .container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        .app-header {
            padding: 25px;
            text-align: center;
            background: linear-gradient(135deg, #0c2461, #1e3799);
            color: white;
        }
        
        .app-header h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }
        
        .tabs {
            display: flex;
            background: #2c3e50;
            border-bottom: 3px solid #0c2461;
            overflow-x: auto;
            flex-direction: row;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-btn {
            padding: 18px 24px;
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            white-space: nowrap;
            flex-shrink: 0;
            min-height: 44px;
            min-width: 44px;
        }
        
        .tab-btn:hover, .tab-btn.active {
            background: #0c2461;
        }
        
        .tab-pane {
            padding: 25px;
            display: none;
            min-height: 500px;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        .btn-primary {
            background: #0c2461;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            min-height: 44px;
            min-width: 44px;
        }
        
        .btn-primary:hover {
            background: #1e3799;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            min-height: 44px;
            min-width: 44px;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            min-height: 44px;
            min-width: 44px;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            min-height: 44px;
            min-width: 44px;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .player-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .player-card h4 {
            color: #0c2461;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .squadra-badge {
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .captain-badge {
            background: #ffd700;
            color: #0c2461;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .portiere-badge {
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            min-height: 44px;
            min-width: 44px;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #0c2461;
        }
        
        .squadre-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .squadra-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 5px solid;
        }
        
        .squadra-card h3 {
            color: #0c2461;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .squadra-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            border: 2px solid #ddd;
            cursor: pointer;
        }
        
        .giocatori-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .giocatore-item {
            padding: 8px 10px;
            background: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-icon {
            color: #e74c3c;
            margin-left: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .close-modal:hover {
            color: #e74c3c;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stats-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .player-stats-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .player-stats-row:last-child {
            border-bottom: none;
        }
        
        .stat-input {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .stat-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-right: 5px;
            text-decoration: none !important;
        }
        
        .gol-badge { background: #27ae60; color: white; }
        .assist-badge { background: #3498db; color: white; }
        .giallo-badge { background: #f1c40f; color: black; }
        .rosso-badge { background: #e74c3c; color: white; }
        
        .classifica-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .classifica-table th {
            background: #0c2461;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .classifica-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .classifica-table tr:hover {
            background: #f8f9fa;
        }
        
        .posizione {
            font-weight: bold;
            color: #0c2461;
            width: 50px;
            text-align: center;
        }
        
        .posizione-1 { color: #ffd700; font-size: 18px; }
        .posizione-2 { color: #c0c0c0; font-size: 16px; }
        .posizione-3 { color: #cd7f32; font-size: 14px; }
        
        .risultati-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .risultato-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid;
        }
        
        .risultato-card.incompleto {
            border-left-color: #e74c3c;
        }
        
        .player-colored {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            margin: 2px;
            text-decoration: none !important;
            border: none !important;
        }
        
        .team-colored {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            margin: 0 5px;
            text-decoration: none !important;
            border: none !important;
        }
        
        .squadra-giocatori-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid;
        }
        
        .giocatore-nome {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            margin: 3px;
            text-decoration: none !important;
            border: none !important;
        }
        
        .risultati-container .player-colored,
        .risultati-container .team-colored,
        .risultati-container .gol-badge,
        .risultati-container .assist-badge,
        .risultati-container .giallo-badge,
        .risultati-container .rosso-badge {
            text-decoration: none !important;
            border-bottom: none !important;
            border: none !important;
        }
        
        .calendario-nome-squadra {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            margin: 0 5px;
            text-decoration: none !important;
            border: none !important;
        }
        
        .risultato-numero {
            font-size: 28px;
            font-weight: bold;
            color: #0c2461;
            margin: 0 10px;
            text-decoration: none !important;
            border: none !important;
        }
        
        .pwa-mode .user-info-bar {
            padding-top: calc(12px + env(safe-area-inset-top, 0px));
        }
        
        /* MIGLIORAMENTI PER MOBILE */
        @media (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important; /* Previene zoom iOS */
            }
            
            button, .user-btn, .tab-btn {
                min-height: 44px; /* Dimensione touch minima */
                min-width: 44px;
            }
            
            /* Previene il refresh su drag */
            body {
                overscroll-behavior: contain;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Migliora la visualizzazione modali */
            .modal-content {
                width: 95% !important;
                max-height: 85vh !important;
                padding: 20px !important;
            }
            
            .tabs {
                flex-direction: row;
                overflow-x: auto;
            }
            
            .tab-btn {
                padding: 15px;
                font-size: 14px;
            }
            
            .user-info-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .squadre-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .risultati-grid {
                grid-template-columns: 1fr;
            }
            
            .players-grid {
                grid-template-columns: 1fr;
            }
            
            button[onclick*="Installa"] {
                bottom: 80px !important;
            }
        }
        
        @media (max-width: 480px) {
            .tab-btn {
                padding: 12px 15px;
                font-size: 13px;
            }
            
            .player-colored, .team-colored {
                font-size: 14px;
                padding: 2px 6px;
            }
        }
    </style>
</head>
<body>

<!-- SPLASH SCREEN PWA -->
<div id="splash-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0c2461, #1e3799); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; display: none;">
  <div style="font-size: 3rem; color: white; margin-bottom: 20px;"><i class="fas fa-shield-alt"></i></div>
  <div style="color: white; font-size: 1.5rem; animation: pulse 2s infinite;">Campionato Arena 2026</div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-container">
    <div class="logo">
        <i class="fas fa-shield-alt"></i>
        <span>Campionato Arena 2026</span>
    </div>
    
    <h3><i class="fas fa-user-lock"></i> Seleziona il tuo profilo:</h3>
    
    <div class="user-list">
        <!-- Amministratori -->
        <button class="user-btn admin-btn" onclick="selezionaAdmin('Vitantonio')">
            <div>
                <i class="fas fa-crown"></i> Vitantonio
            </div>
            <span class="admin-badge">Amministratore</span>
        </button>
        
        <button class="user-btn admin-btn" onclick="selezionaAdmin('Jacopo')">
            <div>
                <i class="fas fa-crown"></i> Jacopo
            </div>
            <span class="admin-badge">Amministratore</span>
        </button>
        
        <button class="user-btn admin-btn" onclick="selezionaAdmin('Fabrizio')">
            <div>
                <i class="fas fa-crown"></i> Fabrizio
            </div>
            <span class="admin-badge">Amministratore</span>
        </button>
        
        <!-- Separatore -->
        <div style="text-align: center; margin: 20px 0; color: #666; font-size: 14px;">
            <i class="fas fa-users"></i> ALTRI PARTECIPANTI
        </div>
        
        <!-- Giocatori/Partecipanti -->
        <div id="playerList">
            <p style="color: #888; font-style: italic; padding: 10px;">
                I partecipanti appariranno qui dopo essere stati registrati dagli amministratori
            </p>
        </div>
    </div>
    
    <!-- Sezione Password -->
    <div id="passwordSection" class="password-section">
        <h4 id="selectedAdminText">Inserisci password per: </h4>
        <input type="password" id="passwordInput" class="password-input" placeholder="Password...">
        <button onclick="verificaPassword()" class="login-btn">
            <i class="fas fa-sign-in-alt"></i> Accedi
        </button>
        <div id="loginError" class="error-msg" style="display: none;">
            <i class="fas fa-exclamation-circle"></i> Password errata!
        </div>
    </div>
    
    <div style="margin-top: 25px; font-size: 14px; color: #666; padding: 10px; background: #f8f9fa; border-radius: 8px;">
        <i class="fas fa-info-circle"></i> Gli amministratori hanno bisogno di password per accedere
    </div>
</div>

<!-- APP PRINCIPALE -->
<div id="appContainer" class="container">
    
    <!-- BARRA SUPERIORE CON INFO UTENTE -->
    <div class="user-info-bar">
        <div>
            <span id="currentUserDisplay" class="current-user">
                <i class="fas fa-user"></i> Accesso non effettuato
            </span>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <!-- PULSANTE SALVA ORA -->
            <button onclick="forzaSalvataggio()" class="btn-secondary" style="padding: 8px 15px;">
                <i class="fas fa-save"></i> Salva Ora
            </button>
            
            <span id="userRole"></span>
            <button onclick="logout()" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
    
    <!-- HEADER APP -->
    <div class="app-header">
        <h1><i class="fas fa-shield-alt"></i> Campionato Arena 2026</h1>
    </div>

    <!-- TABS NAVIGATION -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="squadre"><i class="fas fa-users"></i> Squadre</button>
        <button class="tab-btn" data-tab="calendario"><i class="fas fa-calendar-alt"></i> Calendario</button>
        <button class="tab-btn" data-tab="risultati"><i class="fas fa-futbol"></i> Risultati</button>
        <button class="tab-btn" data-tab="classifiche"><i class="fas fa-list-ol"></i> Classifiche</button>
        <button class="tab-btn" data-tab="players"><i class="fas fa-user-plus"></i> Partecipanti</button>
    </div>

    <!-- CONTENUTI TABS -->
    <div class="tab-content">
        <!-- Squadre Tab -->
        <div id="squadre-tab" class="tab-pane active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-users"></i> Squadre del Campionato</h2>
                <button id="creaSquadraBtn" class="btn-primary" style="display: none;">
                    <i class="fas fa-plus"></i> Crea Nuova Squadra
                </button>
            </div>
            <p style="color: #666; margin-bottom: 20px;">Gestisci le 5 squadre: modifica nomi, colori e assegna giocatori</p>
            <div id="squadre-container">
                <!-- Le squadre verranno visualizzate qui -->
            </div>
        </div>

        <!-- Calendario Tab -->
        <div id="calendario-tab" class="tab-pane">
            <h2><i class="fas fa-calendar-alt"></i> Calendario Partite</h2>
            <p style="color: #666; margin-bottom: 20px;">Inserisci manualmente il calendario delle partite</p>
            <div id="calendario-container">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                    <h3><i class="fas fa-calendar-plus"></i> Aggiungi Nuova Partita</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label>Giornata:</label>
                            <select id="giornataSelect" class="form-control">
                                <option value="1">Giornata 1</option>
                                <option value="2">Giornata 2</option>
                                <option value="3">Giornata 3</option>
                                <option value="4">Giornata 4</option>
                                <option value="5">Giornata 5</option>
                                <option value="6">Giornata 6</option>
                                <option value="7">Giornata 7</option>
                                <option value="8">Giornata 8</option>
                                <option value="9">Giornata 9</option>
                                <option value="10">Giornata 10</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Data Partita:</label>
                            <input type="date" id="dataPartita" class="form-control">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; margin: 20px 0;">
                        <div class="form-group">
                            <label>Squadra Casa:</label>
                            <select id="squadraCasaSelect" class="form-control">
                                <option value="">Seleziona squadra</option>
                            </select>
                        </div>
                        
                        <div style="text-align: center; font-size: 28px; color: #0c2461; font-weight: bold;">
                            VS
                        </div>
                        
                        <div class="form-group">
                            <label>Squadra Trasferta:</label>
                            <select id="squadraTrasfertaSelect" class="form-control">
                                <option value="">Seleziona squadra</option>
                            </select>
                        </div>
                    </div>
                    
                    <button id="aggiungiPartitaBtn" class="btn-primary" style="width: 100%;">
                        <i class="fas fa-plus"></i> Aggiungi Partita al Calendario
                    </button>
                </div>
                
                <div id="partiteList">
                    <h3><i class="fas fa-list"></i> Partite Inserite:</h3>
                    <div id="partiteContainer"></div>
                </div>
            </div>
        </div>

        <!-- Risultati Tab -->
        <div id="risultati-tab" class="tab-pane">
            <h2><i class="fas fa-futbol"></i> Risultati Partite</h2>
            <p style="color: #666; margin-bottom: 20px;">Visualizza e modifica i risultati delle partite già giocate</p>
            <div id="risultati-container">
                <!-- I risultati appariranno qui -->
            </div>
        </div>

        <!-- Classifiche Tab -->
        <div id="classifiche-tab" class="tab-pane">
            <h2><i class="fas fa-list-ol"></i> Classifiche</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn-primary" onclick="showClassifica('squadre')">
                    <i class="fas fa-users"></i> Classifica Squadre
                </button>
                <button class="btn-secondary" onclick="showClassifica('marcatori')">
                    <i class="fas fa-futbol"></i> Classifica Marcatori
                </button>
                <button class="btn-secondary" onclick="showClassifica('assist')">
                    <i class="fas fa-handshake"></i> Classifica Assist
                </button>
                <button class="btn-secondary" onclick="showClassifica('cartellini')">
                    <i class="fas fa-square"></i> Cartellini
                </button>
            </div>
            <div id="classifiche-container">
                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                    <i class="fas fa-trophy fa-3x" style="color: #ddd; margin-bottom: 15px;"></i>
                    <h3>Seleziona un tipo di classifica</h3>
                    <p>Clicca su uno dei pulsanti sopra per visualizzare le classifiche</p>
                </div>
            </div>
        </div>

        <!-- Partecipanti Tab -->
        <div id="players-tab" class="tab-pane">
            <h2><i class="fas fa-user-plus"></i> Gestione Partecipanti</h2>
            <p style="color: #666; margin-bottom: 20px;">Aggiungi i partecipanti al campionato e assegnali alle squadre</p>
            
            <div id="adminOnlySection" style="display: none; margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 5px solid #0c2461;">
                <h3><i class="fas fa-user-plus"></i> Aggiungi Nuovo Partecipante</h3>
                <div class="form-group">
                    <label for="newPlayerName">Nome e cognome del partecipante:</label>
                    <input type="text" id="newPlayerName" class="form-control" placeholder="Es: Marco Rossi">
                </div>
                
                <div class="form-group">
                    <label for="playerSquadra">Squadra:</label>
                    <select id="playerSquadra" class="form-control">
                        <option value="">Seleziona squadra...</option>
                    </select>
                </div>
                
                <button id="addPlayerBtn" class="btn-primary" style="width: 100%;">
                    <i class="fas fa-plus"></i> Aggiungi Partecipante alla Squadra
                </button>
                
                <p style="color: #666; font-size: 14px; margin-top: 10px;">
                    <i class="fas fa-info-circle"></i> I partecipanti potranno accedere senza password, solo con il loro nome
                </p>
            </div>
            
            <div id="players-list-container">
                <h3><i class="fas fa-list"></i> Partecipanti Registrati (Raggruppati per Squadra):</h3>
                <div id="playersByTeamContainer">
                    <!-- I partecipanti raggruppati per squadra appariranno qui -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALE MODIFICA SQUADRA -->
<div id="modificaSquadraModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Modifica Squadra</h3>
            <button class="close-modal" onclick="chiudiModale('modificaSquadraModal')">&times;</button>
        </div>
        <div id="modificaSquadraContent">
            <!-- Contenuto dinamico -->
        </div>
    </div>
</div>

<!-- MODALE INSERISCI/MODIFICA RISULTATI -->
<div id="risultatiModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-futbol"></i> Inserisci/Modifica Risultato e Statistiche</h3>
            <button class="close-modal" onclick="chiudiModale('risultatiModal')">&times;</button>
        </div>
        <div id="risultatiModalContent">
            <!-- Contenuto dinamico -->
        </div>
    </div>
</div>

<script>
// ====================
// DATABASE
// ====================
let database = {
    currentUser: null,
    isAdmin: false,
    selectedAdmin: null,
    currentPartitaModifica: null,
    
    adminPasswords: {
        'Vitantonio': 'giulia85',
        'Jacopo': 'forzaroma1',
        'Fabrizio': 'manetta1'
    },
    
    squadre: [
        { id: 1, nome: "Squadra 1", colore: "#3498db", giocatori: [], capitano: null, portiere: null },
        { id: 2, nome: "Squadra 2", colore: "#e74c3c", giocatori: [], capitano: null, portiere: null },
        { id: 3, nome: "Squadra 3", colore: "#2ecc71", giocatori: [], capitano: null, portiere: null },
        { id: 4, nome: "Squadra 4", colore: "#f39c12", giocatori: [], capitano: null, portiere: null },
        { id: 5, nome: "Squadra 5", colore: "#9b59b6", giocatori: [], capitano: null, portiere: null }
    ],
    
    players: ['Vitantonio', 'Jacopo', 'Fabrizio'],
    playerSquadra: {},
    partite: [],
    statistichePartite: {}
};

// ====================
// FUNZIONI DI UTILITÀ
// ====================

function getPlayerColor(playerName) {
    const squadraId = database.playerSquadra[playerName];
    const squadra = database.squadre.find(s => s.id === squadraId);
    return squadra ? squadra.colore : '#666666';
}

function formatPlayerNameWithTeamColor(playerName, includeCaptainBadge = true, includeGoalkeeperBadge = true) {
    const squadraId = database.playerSquadra[playerName];
    const squadra = database.squadre.find(s => s.id === squadraId);
    const isCaptain = squadra && squadra.capitano === playerName;
    const isGoalkeeper = squadra && squadra.portiere === playerName;
    const playerColor = getPlayerColor(playerName);
    
    let html = `<span class="player-colored" style="background-color: ${playerColor};">`;
    html += playerName;
    if (includeCaptainBadge && isCaptain) {
        html += ' <span class="captain-badge">(C)</span>';
    }
    if (includeGoalkeeperBadge && isGoalkeeper) {
        html += ' <span class="portiere-badge">(P)</span>';
    }
    html += '</span>';
    
    return html;
}

function formatTeamNameWithColor(teamId) {
    const squadra = database.squadre.find(s => s.id === teamId);
    if (!squadra) return 'Squadra Sconosciuta';
    
    return `<span class="team-colored" style="background-color: ${squadra.colore};">${squadra.nome}</span>`;
}

// ====================
// FUNZIONI LOGIN
// ====================

function selezionaAdmin(nomeAdmin) {
    database.selectedAdmin = nomeAdmin;
    document.getElementById('passwordSection').style.display = 'block';
    document.getElementById('selectedAdminText').innerHTML = `Inserisci password per <strong>${nomeAdmin}</strong>:`;
    document.getElementById('passwordInput').focus();
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('passwordInput').value = '';
}

function verificaPassword() {
    const passwordInput = document.getElementById('passwordInput');
    const enteredPassword = passwordInput.value;
    
    if (database.selectedAdmin && database.adminPasswords[database.selectedAdmin]) {
        if (enteredPassword === database.adminPasswords[database.selectedAdmin]) {
            login(database.selectedAdmin, true);
        } else {
            document.getElementById('loginError').style.display = 'block';
            passwordInput.focus();
        }
    }
}

function login(userName, isAdminUser = false) {
    database.currentUser = userName;
    database.isAdmin = isAdminUser || Object.keys(database.adminPasswords).includes(userName);
    
    if (database.isAdmin && !database.players.includes(userName)) {
        database.players.push(userName);
    }
    
    saveToLocalStorage();
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    updateUserDisplay();
    updateAdminSection();
    switchTab('squadre');
    loadFromLocalStorage();
    updatePlayersByTeamView();
    updateLoginScreen();
    updateSquadreView();
    updateSquadreSelect();
    updatePartiteView();
    updateRisultatiView();
}

function logout() {
    if (confirm('Sei sicuro di voler uscire?')) {
        database.currentUser = null;
        database.isAdmin = false;
        database.selectedAdmin = null;
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('passwordSection').style.display = 'none';
        updateLoginScreen();
    }
}

function updateUserDisplay() {
    const userDisplay = document.getElementById('currentUserDisplay');
    const userRole = document.getElementById('userRole');
    
    if (database.currentUser) {
        const squadraId = database.playerSquadra[database.currentUser];
        const squadra = database.squadre.find(s => s.id === squadraId);
        const isCaptain = squadra && squadra.capitano === database.currentUser;
        const isGoalkeeper = squadra && squadra.portiere === database.currentUser;
        const icon = database.isAdmin ? 'fa-crown' : 'fa-user';
        const playerColor = getPlayerColor(database.currentUser);
        
        userDisplay.innerHTML = `
            <i class="fas ${icon}"></i> 
            <span class="player-colored" style="background-color: ${playerColor};">${database.currentUser}</span>
            ${isCaptain ? '<span class="captain-badge">Capitano</span>' : ''}
            ${isGoalkeeper ? '<span class="portiere-badge">Portiere</span>' : ''}
            ${database.isAdmin ? '<span style="font-size: 12px; opacity: 0.8;"> (Admin)</span>' : ''}
        `;
        
        userDisplay.style.background = database.isAdmin ? '#e74c3c' : '#ffd700';
        userDisplay.style.color = database.isAdmin ? 'white' : '#0c2461';
        
        let roleHTML = '';
        if (database.isAdmin) {
            roleHTML = '<span style="background: #e74c3c; color: white; padding: 5px 15px; border-radius: 15px; font-size: 14px;"><i class="fas fa-crown"></i> Amministratore</span>';
        } else if (isCaptain) {
            roleHTML = '<span style="background: #ffd700; color: #0c2461; padding: 5px 15px; border-radius: 15px; font-size: 14px;"><i class="fas fa-star"></i> Capitano</span>';
        } else if (isGoalkeeper) {
            roleHTML = '<span style="background: #3498db; color: white; padding: 5px 15px; border-radius: 15px; font-size: 14px;"><i class="fas fa-helmet-safety"></i> Portiere</span>';
        } else {
            roleHTML = '<span style="background: #27ae60; color: white; padding: 5px 15px; border-radius: 15px; font-size: 14px;"><i class="fas fa-user"></i> Partecipante</span>';
        }
        userRole.innerHTML = roleHTML;
    }
}

function updateLoginScreen() {
    const playerListContainer = document.getElementById('playerList');
    playerListContainer.innerHTML = '';
    
    const nonAdminPlayers = database.players.filter(player => 
        !Object.keys(database.adminPasswords).includes(player)
    );
    
    if (nonAdminPlayers.length > 0) {
        nonAdminPlayers.forEach(player => {
            const btn = document.createElement('button');
            btn.className = 'user-btn';
            const squadraId = database.playerSquadra[player];
            const squadra = database.squadre.find(s => s.id === squadraId);
            const isCaptain = squadra && squadra.capitano === player;
            const isGoalkeeper = squadra && squadra.portiere === player;
            const playerColor = getPlayerColor(player);
            
            btn.innerHTML = `
                <div>
                    <i class="fas fa-user"></i> 
                    <span style="display: inline-block; padding: 2px 8px; border-radius: 4px; background-color: ${playerColor}; color: white; margin-right: 5px;">
                        ${player}
                        ${isCaptain ? ' (C)' : ''}
                        ${isGoalkeeper ? ' (P)' : ''}
                    </span>
                </div>
                <span class="player-badge">${squadra ? squadra.nome : 'Nessuna squadra'}</span>
            `;
            
            btn.onclick = function() { login(player, false); };
            playerListContainer.appendChild(btn);
        });
    } else {
        playerListContainer.innerHTML = `
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; color: #666;">
                <i class="fas fa-info-circle"></i> 
                Gli amministratori possono aggiungere altri partecipanti
            </div>
        `;
    }
}

// ====================
// SALVATAGGIO MIGLIORATO PER MOBILE
// ====================

function saveToLocalStorage() {
    try {
        const data = {
            squadre: database.squadre,
            players: database.players,
            playerSquadra: database.playerSquadra,
            partite: database.partite,
            statistichePartite: database.statistichePartite,
            timestamp: new Date().toISOString()
        };
        
        // Prova prima localStorage
        localStorage.setItem('campionatoArenaDB', JSON.stringify(data));
        console.log('✅ Dati salvati in localStorage');
        
        // Backup in sessionStorage
        sessionStorage.setItem('campionatoBackup', JSON.stringify(data));
        
        // Notifica all'utente (opzionale)
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('Dati salvati!', {
                body: 'I dati sono stati salvati correttamente',
                icon: 'icon-192.png'
            });
        }
        
        return true;
    } catch (error) {
        console.error('❌ Errore salvataggio:', error);
        
        // Fallback: usa IndexedDB
        if (window.indexedDB) {
            saveToIndexedDB();
        }
        
        alert('Attenzione: potrebbero esserci problemi con il salvataggio dati. Prova a usare la modalità normale (non incognito).');
        return false;
    }
}

function forzaSalvataggio() {
    if (saveToLocalStorage()) {
        // Mostra feedback visivo
        const btn = event.target;
        btn.innerHTML = '<i class="fas fa-check"></i> Salvato!';
        btn.style.background = '#27ae60';
        
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-save"></i> Salva Ora';
            btn.style.background = '';
        }, 2000);
        
        alert('Dati salvati con successo!');
    }
}

// Versione migliorata di loadFromLocalStorage
function loadFromLocalStorage() {
    try {
        const saved = localStorage.getItem('campionatoArenaDB');
        if (saved) {
            const parsed = JSON.parse(saved);
            database.squadre = parsed.squadre || database.squadre;
            database.players = parsed.players || database.players;
            database.playerSquadra = parsed.playerSquadra || database.playerSquadra;
            database.partite = parsed.partite || [];
            database.statistichePartite = parsed.statistichePartite || {};
            console.log('✅ Dati caricati da localStorage');
            return true;
        }
    } catch (error) {
        console.error('❌ Errore caricamento:', error);
        
        // Prova sessionStorage
        try {
            const backup = sessionStorage.getItem('campionatoBackup');
            if (backup) {
                const parsed = JSON.parse(backup);
                database.squadre = parsed.squadre || database.squadre;
                database.players = parsed.players || database.players;
                database.playerSquadra = parsed.playerSquadra || database.playerSquadra;
                database.partite = parsed.partite || [];
                database.statistichePartite = parsed.statistichePartite || {};
                console.log('✅ Dati caricati da backup sessionStorage');
            }
        } catch (e) {
            console.error('❌ Errore backup:', e);
        }
    }
    return false;
}

// IndexedDB fallback
function saveToIndexedDB() {
    if (!window.indexedDB) return;
    
    const request = indexedDB.open('CampionatoArenaDB', 1);
    
    request.onupgradeneeded = function(event) {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('dati')) {
            db.createObjectStore('dati');
        }
    };
    
    request.onsuccess = function(event) {
        const db = event.target.result;
        const transaction = db.transaction(['dati'], 'readwrite');
        const store = transaction.objectStore('dati');
        
        const data = {
            squadre: database.squadre,
            players: database.players,
            playerSquadra: database.playerSquadra,
            partite: database.partite,
            statistichePartite: database.statistichePartite,
            timestamp: new Date().toISOString()
        };
        
        store.put(data, 'campionatoData');
        console.log('✅ Dati salvati in IndexedDB (fallback)');
    };
}

// Salvataggio automatico ogni 30 secondi
setInterval(() => {
    if (database.currentUser) {
        saveToLocalStorage();
    }
}, 30000);

// ====================
// INIZIALIZZAZIONE APP
// ====================

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            switchTab(tabId);
        });
    });
    
    document.getElementById('addPlayerBtn')?.addEventListener('click', function() {
        if (!database.isAdmin) {
            alert('Solo gli amministratori possono aggiungere partecipanti!');
            return;
        }
        
        const input = document.getElementById('newPlayerName');
        const playerName = input.value.trim();
        const squadraSelect = document.getElementById('playerSquadra');
        const squadraId = parseInt(squadraSelect.value);
        
        if (playerName.length < 2) {
            alert('Inserisci un nome valido (almeno 2 caratteri)');
            return;
        }
        
        if (!squadraId) {
            alert('Devi selezionare una squadra per il partecipante!');
            return;
        }
        
        const exists = database.players.includes(playerName);
        
        if (exists) {
            alert('Questo nome è già stato registrato!');
            return;
        }
        
        database.players.push(playerName);
        database.playerSquadra[playerName] = squadraId;
        
        const squadra = database.squadre.find(s => s.id === squadraId);
        if (squadra) {
            squadra.giocatori.push(playerName);
        }
        
        input.value = '';
        squadraSelect.value = '';
        
        saveToLocalStorage();
        updatePlayersByTeamView();
        updateLoginScreen();
        updateSquadreView();
        updateSquadreSelect();
        
        alert(`Partecipante "${playerName}" aggiunto alla ${squadra.nome} con successo!`);
    });
    
    document.getElementById('creaSquadraBtn')?.addEventListener('click', function() {
        if (!database.isAdmin) {
            alert('Solo gli amministratori possono creare squadre!');
            return;
        }
        
        const nomeSquadra = prompt("Inserisci il nome della nuova squadra:");
        if (!nomeSquadra || nomeSquadra.trim() === '') return;
        
        const nome = nomeSquadra.trim();
        
        if (database.squadre.some(s => s.nome.toLowerCase() === nome.toLowerCase())) {
            alert(`Esiste già una squadra chiamata "${nome}"!`);
            return;
        }
        
        const maxId = database.squadre.length > 0 ? 
            Math.max(...database.squadre.map(s => s.id)) : 0;
        
        const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e', '#d35400'];
        const colore = colors[database.squadre.length % colors.length];
        
        const nuovaSquadra = {
            id: maxId + 1,
            nome: nome,
            colore: colore,
            giocatori: [],
            capitano: null,
            portiere: null
        };
        
        database.squadre.push(nuovaSquadra);
        
        saveToLocalStorage();
        updateSquadreView();
        updateSquadreSelect();
        
        alert(`Squadra "${nome}" creata con successo!`);
    });
    
    document.getElementById('aggiungiPartitaBtn')?.addEventListener('click', function() {
        const giornata = parseInt(document.getElementById('giornataSelect').value);
        const squadraCasaId = parseInt(document.getElementById('squadraCasaSelect').value);
        const squadraTrasfertaId = parseInt(document.getElementById('squadraTrasfertaSelect').value);
        const dataPartita = document.getElementById('dataPartita').value;
        
        if (!giornata || !squadraCasaId || !squadraTrasfertaId || !dataPartita) {
            alert('Compila tutti i campi!');
            return;
        }
        
        if (squadraCasaId === squadraTrasfertaId) {
            alert('Una squadra non può giocare contro se stessa!');
            return;
        }
        
        const squadraCasa = database.squadre.find(s => s.id === squadraCasaId);
        const squadraTrasferta = database.squadre.find(s => s.id === squadraTrasfertaId);
        
        if (!squadraCasa || !squadraTrasferta) {
            alert('Squadra non trovata!');
            return;
        }
        
        const nuovaPartita = {
            id: database.partite.length + 1,
            giornata: giornata,
            data: dataPartita,
            squadraCasa: squadraCasaId,
            nomeCasa: squadraCasa.nome,
            coloreCasa: squadraCasa.colore,
            squadraTrasferta: squadraTrasfertaId,
            nomeTrasferta: squadraTrasferta.nome,
            coloreTrasferta: squadraTrasferta.colore,
            golCasa: null,
            golTrasferta: null,
            completata: false,
            statisticheInserite: false
        };
        
        database.partite.push(nuovaPartita);
        document.getElementById('dataPartita').value = '';
        saveToLocalStorage();
        updatePartiteView();
        updateRisultatiView();
        alert(`Partita aggiunta alla giornata ${giornata}!`);
    });
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dataPartita').value = today;
    
    loadFromLocalStorage();
    updatePlayersByTeamView();
    updateLoginScreen();
    updateSquadreView();
    updateSquadreSelect();
    updatePartiteView();
    updateRisultatiView();
});

// ====================
// FUNZIONI PRINCIPALI
// ====================

function switchTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-tab') === tabId) {
            btn.classList.add('active');
        }
    });
    
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    const selectedTab = document.getElementById(`${tabId}-tab`);
    if (selectedTab) {
        selectedTab.classList.add('active');
    }
}

function updatePlayersByTeamView() {
    const container = document.getElementById('playersByTeamContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    const giocatoriPerSquadra = {};
    
    database.players.forEach(player => {
        const squadraId = database.playerSquadra[player];
        if (squadraId) {
            if (!giocatoriPerSquadra[squadraId]) {
                giocatoriPerSquadra[squadraId] = [];
            }
            giocatoriPerSquadra[squadraId].push(player);
        }
    });
    
    database.squadre.forEach(squadra => {
        const giocatori = giocatoriPerSquadra[squadra.id] || [];
        if (giocatori.length === 0 && !database.isAdmin) return;
        
        const groupDiv = document.createElement('div');
        groupDiv.className = 'squadra-giocatori-group';
        groupDiv.style.borderLeftColor = squadra.colore;
        
        let giocatoriHTML = '';
        giocatori.forEach(giocatore => {
            const isAdmin = Object.keys(database.adminPasswords).includes(giocatore);
            const isCaptain = squadra.capitano === giocatore;
            const isGoalkeeper = squadra.portiere === giocatore;
            const playerColor = getPlayerColor(giocatore);
            
            giocatoriHTML += `
                <div style="display: inline-block; margin: 5px;">
                    <span class="giocatore-nome" style="background-color: ${playerColor};">
                        ${giocatore}
                        ${isCaptain ? ' <span class="captain-badge">(C)</span>' : ''}
                        ${isGoalkeeper ? ' <span class="portiere-badge">(P)</span>' : ''}
                        ${isAdmin ? ' <i class="fas fa-crown admin-icon"></i>' : ''}
                    </span>
                </div>
            `;
        });
        
        groupDiv.innerHTML = `
            <h4 style="color: ${squadra.colore}; margin-bottom: 10px;">
                <i class="fas fa-users"></i> ${squadra.nome}
                <span style="font-size: 14px; color: #666; margin-left: 10px;">
                    (${giocatori.length} giocatori)
                </span>
            </h4>
            <div>
                ${giocatoriHTML || '<p style="color: #888; font-style: italic;">Nessun giocatore in questa squadra</p>'}
            </div>
        `;
        
        container.appendChild(groupDiv);
    });
    
    if (database.isAdmin) {
        const giocatoriSenzaSquadra = database.players.filter(p => !database.playerSquadra[p]);
        if (giocatoriSenzaSquadra.length > 0) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'squadra-giocatori-group';
            groupDiv.style.borderLeftColor = '#666';
            
            let giocatoriHTML = '';
            giocatoriSenzaSquadra.forEach(giocatore => {
                const isAdmin = Object.keys(database.adminPasswords).includes(giocatore);
                
                giocatoriHTML += `
                    <div style="display: inline-block; margin: 5px;">
                        <span class="giocatore-nome" style="background-color: #666;">
                            ${giocatore}
                            ${isAdmin ? ' <i class="fas fa-crown admin-icon"></i>' : ''}
                        </span>
                    </div>
                `;
            });
            
            groupDiv.innerHTML = `
                <h4 style="color: #666; margin-bottom: 10px;">
                    <i class="fas fa-question-circle"></i> Senza Squadra
                    <span style="font-size: 14px; color: #666; margin-left: 10px;">
                        (${giocatoriSenzaSquadra.length} giocatori)
                    </span>
                </h4>
                <div>
                    ${giocatoriHTML}
                </div>
            `;
            
            container.appendChild(groupDiv);
        }
    }
}

function updateSquadreView() {
    const container = document.getElementById('squadre-container');
    const creaSquadraBtn = document.getElementById('creaSquadraBtn');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    if (creaSquadraBtn) {
        creaSquadraBtn.style.display = database.isAdmin ? 'inline-flex' : 'none';
    }
    
    if (database.squadre.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                <i class="fas fa-users fa-3x" style="color: #ddd; margin-bottom: 15px;"></i>
                <h3>Nessuna squadra creata</h3>
                <p>Crea le squadre per iniziare il campionato</p>
            </div>
        `;
        return;
    }
    
    const squadreGrid = document.createElement('div');
    squadreGrid.className = 'squadre-grid';
    
    database.squadre.forEach(squadra => {
        const card = document.createElement('div');
        card.className = 'squadra-card';
        card.style.borderTopColor = squadra.colore;
        
        let giocatoriHTML = '';
        if (squadra.giocatori.length > 0) {
            squadra.giocatori.forEach(giocatore => {
                const isAdmin = Object.keys(database.adminPasswords).includes(giocatore);
                const isCaptain = squadra.capitano === giocatore;
                const isGoalkeeper = squadra.portiere === giocatore;
                const playerColor = getPlayerColor(giocatore);
                
                giocatoriHTML += `
                    <div class="giocatore-item">
                        <span>
                            <span class="giocatore-nome" style="background-color: ${playerColor};">
                                ${giocatore}
                                ${isCaptain ? ' <span class="captain-badge">(C)</span>' : ''}
                                ${isGoalkeeper ? ' <span class="portiere-badge">(P)</span>' : ''}
                            </span>
                            ${isAdmin ? ' <i class="fas fa-crown admin-icon"></i>' : ''}
                        </span>
                        <span style="font-size: 12px; color: #666;">
                            ${isAdmin ? 'Admin' : 'Giocatore'}
                            ${isCaptain ? ' • Capitano' : ''}
                            ${isGoalkeeper ? ' • Portiere' : ''}
                        </span>
                    </div>
                `;
            });
        } else {
            giocatoriHTML = '<p style="color: #888; font-style: italic;">Nessun giocatore assegnato</p>';
        }
        
        const azioniHTML = database.isAdmin ? `
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="apriModificaSquadra(${squadra.id})" class="btn-secondary" style="flex: 1;">
                    <i class="fas fa-edit"></i> Modifica
                </button>
                <button onclick="rimuoviSquadra(${squadra.id})" class="btn-danger" style="flex: 1;">
                    <i class="fas fa-trash"></i> Elimina
                </button>
            </div>
        ` : '';
        
        card.innerHTML = `
            <h3>
                <div>
                    <span class="squadra-color" style="background: ${squadra.colore}"></span>
                    ${squadra.nome}
                    ${squadra.capitano ? '<span style="font-size: 12px; color: #666; margin-left: 10px;">Capitano: ' + formatPlayerNameWithTeamColor(squadra.capitano, false, false) + '</span>' : ''}
                    ${squadra.portiere ? '<span style="font-size: 12px; color: #666; margin-left: 10px;">Portiere: ' + formatPlayerNameWithTeamColor(squadra.portiere, false, false) + '</span>' : ''}
                </div>
                <span style="font-size: 14px; color: #666;">
                    ${squadra.giocatori.length} giocatori
                </span>
            </h3>
            <div style="margin-bottom: 10px;">
                <strong>Giocatori:</strong>
            </div>
            <div class="giocatori-list">
                ${giocatoriHTML}
            </div>
            ${azioniHTML}
        `;
        
        squadreGrid.appendChild(card);
    });
    
    container.appendChild(squadreGrid);
}

function apriModificaSquadra(squadraId) {
    if (!database.isAdmin) {
        alert('Solo gli amministratori possono modificare le squadre!');
        return;
    }
    
    const squadra = database.squadre.find(s => s.id === squadraId);
    if (!squadra) return;
    
    const modalContent = document.getElementById('modificaSquadraContent');
    
    let capitanoOptions = '<option value="">Nessun capitano</option>';
    let portiereOptions = '<option value="">Nessun portiere</option>';
    if (squadra.giocatori.length > 0) {
        squadra.giocatori.forEach(giocatore => {
            const selectedCapitano = squadra.capitano === giocatore ? 'selected' : '';
            const selectedPortiere = squadra.portiere === giocatore ? 'selected' : '';
            capitanoOptions += `<option value="${giocatore}" ${selectedCapitano}>${giocatore}</option>`;
            portiereOptions += `<option value="${giocatore}" ${selectedPortiere}>${giocatore}</option>`;
        });
    }
    
    modalContent.innerHTML = `
        <div class="form-group">
            <label>Nome Squadra:</label>
            <input type="text" id="editNomeSquadra" class="form-control" value="${squadra.nome}">
        </div>
        
        <div class="form-group">
            <label>Colore Squadra:</label>
            <input type="color" id="editColoreSquadra" class="form-control" value="${squadra.colore}" style="height: 40px;">
        </div>
        
        <div class="form-group">
            <label>Capitano della squadra:</label>
            <select id="editCapitanoSquadra" class="form-control">
                ${capitanoOptions}
            </select>
        </div>
        
        <div class="form-group">
            <label>Portiere della squadra:</label>
            <select id="editPortiereSquadra" class="form-control">
                ${portiereOptions}
            </select>
        </div>
        
        <div class="form-group">
            <label>Giocatori in questa squadra:</label>
            <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                ${squadra.giocatori.map(g => {
                    const playerColor = getPlayerColor(g);
                    return `
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd;">
                        <span>
                            <span class="giocatore-nome" style="background-color: ${playerColor};">
                                ${g}
                                ${squadra.capitano === g ? ' <span class="captain-badge">(C)</span>' : ''}
                                ${squadra.portiere === g ? ' <span class="portiere-badge">(P)</span>' : ''}
                            </span>
                        </span>
                        <button onclick="rimuoviGiocatoreDaSquadra(${squadraId}, '${g}')" class="btn-danger" style="padding: 2px 8px; font-size: 12px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `}).join('')}
                ${squadra.giocatori.length === 0 ? '<p style="color: #888; text-align: center;">Nessun giocatore</p>' : ''}
            </div>
        </div>
        
        <div class="form-group">
            <label>Aggiungi giocatore esistente:</label>
            <select id="addGiocatoreSelect" class="form-control">
                <option value="">Seleziona giocatore...</option>
                ${database.players.filter(p => database.playerSquadra[p] !== squadraId).map(p => `
                    <option value="${p}">${p}</option>
                `).join('')}
            </select>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="salvaModificheSquadra(${squadraId})" class="btn-primary" style="flex: 1;">
                <i class="fas fa-save"></i> Salva Modifiche
            </button>
            <button onclick="chiudiModale('modificaSquadraModal')" class="btn-secondary" style="flex: 1;">
                <i class="fas fa-times"></i> Annulla
            </button>
        </div>
    `;
    
    document.getElementById('modificaSquadraModal').style.display = 'flex';
}

function rimuoviGiocatoreDaSquadra(squadraId, giocatore) {
    if (!confirm(`Rimuovere ${giocatore} dalla squadra?`)) return;
    
    const squadra = database.squadre.find(s => s.id === squadraId);
    if (squadra) {
        squadra.giocatori = squadra.giocatori.filter(g => g !== giocatore);
        if (squadra.capitano === giocatore) {
            squadra.capitano = null;
        }
        if (squadra.portiere === giocatore) {
            squadra.portiere = null;
        }
        delete database.playerSquadra[giocatore];
        apriModificaSquadra(squadraId);
        saveToLocalStorage();
    }
}

function salvaModificheSquadra(squadraId) {
    const squadra = database.squadre.find(s => s.id === squadraId);
    if (!squadra) return;
    
    const nuovoNome = document.getElementById('editNomeSquadra').value.trim();
    const nuovoColore = document.getElementById('editColoreSquadra').value;
    const nuovoCapitano = document.getElementById('editCapitanoSquadra').value;
    const nuovoPortiere = document.getElementById('editPortiereSquadra').value;
    const giocatoreDaAggiungere = document.getElementById('addGiocatoreSelect').value;
    
    if (!nuovoNome) {
        alert('Il nome della squadra non può essere vuoto!');
        return;
    }
    
    squadra.nome = nuovoNome;
    squadra.colore = nuovoColore;
    
    if (nuovoCapitano && squadra.giocatori.includes(nuovoCapitano)) {
        squadra.capitano = nuovoCapitano;
    } else {
        squadra.capitano = null;
    }
    
    if (nuovoPortiere && squadra.giocatori.includes(nuovoPortiere)) {
        squadra.portiere = nuovoPortiere;
    } else {
        squadra.portiere = null;
    }
    
    if (giocatoreDaAggiungere && !squadra.giocatori.includes(giocatoreDaAggiungere)) {
        const vecchiaSquadraId = database.playerSquadra[giocatoreDaAggiungere];
        if (vecchiaSquadraId) {
            const vecchiaSquadra = database.squadre.find(s => s.id === vecchiaSquadraId);
            if (vecchiaSquadra) {
                vecchiaSquadra.giocatori = vecchiaSquadra.giocatori.filter(g => g !== giocatoreDaAggiungere);
                if (vecchiaSquadra.capitano === giocatoreDaAggiungere) {
                    vecchiaSquadra.capitano = null;
                }
                if (vecchiaSquadra.portiere === giocatoreDaAggiungere) {
                    vecchiaSquadra.portiere = null;
                }
            }
        }
        
        squadra.giocatori.push(giocatoreDaAggiungere);
        database.playerSquadra[giocatoreDaAggiungere] = squadraId;
    }
    
    saveToLocalStorage();
    updateSquadreView();
    updateSquadreSelect();
    updatePlayersByTeamView();
    updateLoginScreen();
    updatePartiteView();
    updateUserDisplay();
    
    chiudiModale('modificaSquadraModal');
    alert('Squadra aggiornata con successo!');
}

function rimuoviSquadra(squadraId) {
    if (!database.isAdmin) {
        alert('Solo gli amministratori possono eliminare le squadre!');
        return;
    }
    
    const squadra = database.squadre.find(s => s.id === squadraId);
    if (!squadra) return;
    
    if (squadra.giocatori.length > 0) {
        alert(`Non puoi eliminare ${squadra.nome} perché ha ${squadra.giocatori.length} giocatori assegnati!`);
        return;
    }
    
    if (!confirm(`Sei sicuro di voler eliminare la squadra "${squadra.nome}"?`)) return;
    
    database.squadre = database.squadre.filter(s => s.id !== squadraId);
    saveToLocalStorage();
    updateSquadreView();
    updateSquadreSelect();
    alert('Squadra eliminata con successo!');
}

function updateSquadreSelect() {
    const selectCasa = document.getElementById('squadraCasaSelect');
    const selectTrasferta = document.getElementById('squadraTrasfertaSelect');
    const selectPartecipanti = document.getElementById('playerSquadra');
    
    function aggiornaSelect(selectElement) {
        if (!selectElement) return;
        const selectedValue = selectElement.value;
        let optionsHTML = '<option value="">Seleziona squadra...</option>';
        database.squadre.forEach(squadra => {
            optionsHTML += `<option value="${squadra.id}">${squadra.nome}</option>`;
        });
        selectElement.innerHTML = optionsHTML;
        if (selectedValue) {
            selectElement.value = selectedValue;
        }
    }
    
    aggiornaSelect(selectCasa);
    aggiornaSelect(selectTrasferta);
    aggiornaSelect(selectPartecipanti);
}

// ====================
// FUNZIONI PER PARTITE E RISULTATI
// ====================

function calcolaClassificaSquadre() {
    const statsSquadre = {};
    
    database.squadre.forEach(squadra => {
        statsSquadre[squadra.id] = {
            nome: squadra.nome,
            colore: squadra.colore,
            partiteGiocate: 0,
            vinte: 0,
            pareggiate: 0,
            perse: 0,
            golFatti: 0,
            golSubiti: 0,
            punti: 0
        };
    });
    
    database.partite.filter(p => p.completata).forEach(partita => {
        const squadraCasa = statsSquadre[partita.squadraCasa];
        const squadraTrasferta = statsSquadre[partita.squadraTrasferta];
        
        if (squadraCasa && squadraTrasferta) {
            squadraCasa.partiteGiocate++;
            squadraTrasferta.partiteGiocate++;
            squadraCasa.golFatti += partita.golCasa;
            squadraCasa.golSubiti += partita.golTrasferta;
            squadraTrasferta.golFatti += partita.golTrasferta;
            squadraTrasferta.golSubiti += partita.golCasa;
            
            if (partita.golCasa > partita.golTrasferta) {
                squadraCasa.vinte++;
                squadraCasa.punti += 3;
                squadraTrasferta.perse++;
            } else if (partita.golCasa < partita.golTrasferta) {
                squadraTrasferta.vinte++;
                squadraTrasferta.punti += 3;
                squadraCasa.perse++;
            } else {
                squadraCasa.pareggiate++;
                squadraTrasferta.pareggiate++;
                squadraCasa.punti += 1;
                squadraTrasferta.punti += 1;
            }
        }
    });
    
    return Object.values(statsSquadre)
        .sort((a, b) => {
            if (b.punti !== a.punti) return b.punti - a.punti;
            if ((b.golFatti - b.golSubiti) !== (a.golFatti - a.golSubiti)) 
                return (b.golFatti - b.golSubiti) - (a.golFatti - a.golSubiti);
            return b.golFatti - a.golFatti;
        });
}

function inserisciRisultato(partitaId) {
    if (!database.isAdmin) {
        alert('Solo gli amministratori possono inserire risultati!');
        return;
    }
    
    const partita = database.partite.find(p => p.id === partitaId);
    if (!partita) return;
    
    database.currentPartitaModifica = partitaId;
    const squadraCasa = database.squadre.find(s => s.id === partita.squadraCasa);
    const squadraTrasferta = database.squadre.find(s => s.id === partita.squadraTrasferta);
    const modalContent = document.getElementById('risultatiModalContent');
    
    if (!database.statistichePartite[partitaId]) {
        database.statistichePartite[partitaId] = { giocatori: {} };
    }
    
    const stats = database.statistichePartite[partitaId];
    
    function creaStatisticheSquadra(squadra, isCasa) {
        let html = `<h4><span class="team-colored" style="background-color: ${squadra.colore};">${squadra.nome}</span></h4>`;
        
        if (squadra.giocatori.length === 0) {
            html += '<p style="color: #888; font-style: italic;">Nessun giocatore in questa squadra</p>';
            return html;
        }
        
        html += '<div class="stats-grid">';
        
        squadra.giocatori.forEach(giocatore => {
            if (!stats.giocatori[giocatore]) {
                stats.giocatori[giocatore] = { gol: 0, assist: 0, gialli: 0, rossi: 0 };
            }
            
            const giocatoreStats = stats.giocatori[giocatore];
            const isAdmin = Object.keys(database.adminPasswords).includes(giocatore);
            const isCaptain = squadra.capitano === giocatore;
            const isGoalkeeper = squadra.portiere === giocatore;
            const playerColor = getPlayerColor(giocatore);
            
            html += `
                <div class="stats-card" style="border-left-color: ${playerColor};">
                    <h5 style="margin-bottom: 10px;">
                        <i class="fas fa-user${isAdmin ? '-crown admin-icon' : ''}"></i> 
                        <span class="player-colored" style="background-color: ${playerColor};">
                            ${giocatore}
                            ${isCaptain ? ' <span class="captain-badge">(C)</span>' : ''}
                            ${isGoalkeeper ? ' <span class="portiere-badge">(P)</span>' : ''}
                        </span>
                    </h5>
                    
                    <div class="player-stats-row">
                        <span>Gol:</span>
                        <input type="number" min="0" class="stat-input" 
                               value="${giocatoreStats.gol}"
                               onchange="aggiornaStatistica('${giocatore}', 'gol', this.value)">
                    </div>
                    
                    <div class="player-stats-row">
                        <span>Assist:</span>
                        <input type="number" min="0" class="stat-input" 
                               value="${giocatoreStats.assist}"
                               onchange="aggiornaStatistica('${giocatore}', 'assist', this.value)">
                    </div>
                    
                    <div class="player-stats-row">
                        <span>Ammonizioni:</span>
                        <input type="number" min="0" max="2" class="stat-input" 
                               value="${giocatoreStats.gialli}"
                               onchange="aggiornaStatistica('${giocatore}', 'gialli', this.value)">
                    </div>
                    
                    <div class="player-stats-row">
                        <span>Espulsioni:</span>
                        <input type="number" min="0" max="1" class="stat-input" 
                               value="${giocatoreStats.rossi}"
                               onchange="aggiornaStatistica('${giocatore}', 'rossi', this.value)">
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        return html;
    }
    
    modalContent.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h4 style="color: #0c2461; margin-bottom: 15px;">
                <i class="fas fa-futbol"></i> ${formatTeamNameWithColor(partita.squadraCasa)} vs ${formatTeamNameWithColor(partita.squadraTrasferta)}
            </h4>
            <div style="color: #666; margin-bottom: 20px;">
                Giornata ${partita.giornata} - ${new Date(partita.data).toLocaleDateString('it-IT')}
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; margin-bottom: 30px;">
                <div style="text-align: center;">
                    <div class="team-colored" style="background-color: ${partita.coloreCasa}; margin-bottom: 10px; font-weight: bold;">
                        ${squadraCasa.nome}
                    </div>
                    <input type="number" id="golCasaInput" min="0" 
                           value="${partita.golCasa !== null ? partita.golCasa : ''}"
                           style="width: 80px; padding: 10px; text-align: center; font-size: 24px; border: 2px solid ${partita.coloreCasa}; border-radius: 8px;">
                </div>
                
                <div style="text-align: center; font-size: 36px; color: #0c2461; font-weight: bold;">
                    -
                </div>
                
                <div style="text-align: center;">
                    <div class="team-colored" style="background-color: ${partita.coloreTrasferta}; margin-bottom: 10px; font-weight: bold;">
                        ${squadraTrasferta.nome}
                    </div>
                    <input type="number" id="golTrasfertaInput" min="0" 
                           value="${partita.golTrasferta !== null ? partita.golTrasferta : ''}"
                           style="width: 80px; padding: 10px; text-align: center; font-size: 24px; border: 2px solid ${partita.coloreTrasferta}; border-radius: 8px;">
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h4><i class="fas fa-chart-bar"></i> Statistiche Giocatori</h4>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <h5>Squadra Casa: ${formatTeamNameWithColor(partita.squadraCasa)}</h5>
                ${creaStatisticheSquadra(squadraCasa, true)}
                
                <hr style="margin: 20px 0;">
                
                <h5>Squadra Trasferta: ${formatTeamNameWithColor(partita.squadraTrasferta)}</h5>
                ${creaStatisticheSquadra(squadraTrasferta, false)}
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="salvaRisultato()" class="btn-primary" style="flex: 1;">
                <i class="fas fa-save"></i> Salva Risultato e Statistiche
            </button>
            <button onclick="chiudiModale('risultatiModal')" class="btn-secondary" style="flex: 1;">
                <i class="fas fa-times"></i> Annulla
            </button>
        </div>
    `;
    
    document.getElementById('risultatiModal').style.display = 'flex';
}

function salvaRisultato() {
    if (!database.currentPartitaModifica) return;
    
    const partitaId = database.currentPartitaModifica;
    const partita = database.partite.find(p => p.id === partitaId);
    if (!partita) return;
    
    const golCasa = parseInt(document.getElementById('golCasaInput').value) || 0;
    const golTrasferta = parseInt(document.getElementById('golTrasfertaInput').value) || 0;
    
    partita.golCasa = golCasa;
    partita.golTrasferta = golTrasferta;
    partita.completata = true;
    partita.statisticheInserite = true;
    
    saveToLocalStorage();
    updatePartiteView();
    updateRisultatiView();
    chiudiModale('risultatiModal');
    
    if (document.getElementById('classifiche-tab').classList.contains('active')) {
        showClassifica('squadre');
    }
    
    alert('Risultato e statistiche salvati con successo!');
}

function updatePartiteView() {
    const container = document.getElementById('partiteContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (database.partite.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <i class="fas fa-calendar-times fa-2x" style="color: #ddd; margin-bottom: 10px;"></i>
                <p>Nessuna partita inserita nel calendario</p>
            </div>
        `;
        return;
    }
    
    const partitePerGiornata = {};
    database.partite.forEach(partita => {
        if (!partitePerGiornata[partita.giornata]) {
            partitePerGiornata[partita.giornata] = [];
        }
        partitePerGiornata[partita.giornata].push(partita);
    });
    
    for (const [giornata, partite] of Object.entries(partitePerGiornata).sort((a, b) => a[0] - b[0])) {
        const giornataDiv = document.createElement('div');
        giornataDiv.style.marginBottom = '30px';
        giornataDiv.style.padding = '20px';
        giornataDiv.style.background = '#f8f9fa';
        giornataDiv.style.borderRadius = '10px';
        
        let partiteHTML = '';
        partite.forEach(partita => {
            const dataFormattata = new Date(partita.data).toLocaleDateString('it-IT', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const risultatoHTML = partita.completata ? 
                `<div style="font-size: 24px; font-weight: bold; color: #0c2461; margin: 10px 0;">
                    <span class="team-colored" style="background-color: ${partita.coloreCasa};">${partita.golCasa}</span> 
                    - 
                    <span class="team-colored" style="background-color: ${partita.coloreTrasferta};">${partita.golTrasferta}</span>
                </div>` :
                '<div style="color: #666; font-style: italic;">Da giocare</div>';
            
            const azioniHTML = database.isAdmin ? `
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="inserisciRisultato(${partita.id})" class="btn-primary" style="flex: 1;">
                        <i class="fas fa-futbol"></i> ${partita.completata ? 'Modifica' : 'Inserisci'} Risultato
                    </button>
                    <button onclick="visualizzaStatistichePartita(${partita.id})" class="btn-secondary" ${!partita.completata ? 'disabled style="opacity: 0.5;"' : ''}>
                        <i class="fas fa-chart-bar"></i> Statistiche
                    </button>
                    <button onclick="eliminaPartita(${partita.id})" class="btn-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            ` : '';
            
            partiteHTML += `
                <div style="background: white; padding: 20px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid ${partita.completata ? '#27ae60' : '#0c2461'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <h4 style="color: #0c2461; margin-bottom: 5px;">
                                <span class="calendario-nome-squadra" style="background-color: ${partita.coloreCasa}; margin-right: 5px;">
                                    ${partita.nomeCasa}
                                </span>
                                vs
                                <span class="calendario-nome-squadra" style="background-color: ${partita.coloreTrasferta}; margin-left: 5px;">
                                    ${partita.nomeTrasferta}
                                </span>
                            </h4>
                            <div style="color: #666; font-size: 14px;">
                                <i class="fas fa-calendar-day"></i> ${dataFormattata}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${partita.completata ? '#27ae60' : '#e74c3c'}; color: white; padding: 5px 15px; border-radius: 15px; font-size: 12px;">
                                <i class="fas ${partita.completata ? 'fa-check-circle' : 'fa-clock'}"></i> 
                                ${partita.completata ? 'Completata' : 'Da giocare'}
                            </span>
                        </div>
                    </div>
                    
                    ${risultatoHTML}
                    
                    ${azioniHTML}
                </div>
            `;
        });
        
        giornataDiv.innerHTML = `
            <h3 style="color: #0c2461; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-calendar-day"></i> Giornata ${giornata}
            </h3>
            ${partiteHTML}
        `;
        
        container.appendChild(giornataDiv);
    }
}

function updateRisultatiView() {
    const container = document.getElementById('risultati-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    const partiteCompletate = database.partite.filter(p => p.completata);
    
    if (partiteCompletate.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                <i class="fas fa-futbol fa-3x" style="color: #ddd; margin-bottom: 15px;"></i>
                <h3>Nessun risultato inserito</h3>
                <p>Vai al tab "Calendario" per inserire i risultati delle partite</p>
            </div>
        `;
        return;
    }
    
    const risultatiGrid = document.createElement('div');
    risultatiGrid.className = 'risultati-grid';
    
    partiteCompletate.forEach(partita => {
        const stats = database.statistichePartite[partita.id] || { giocatori: {} };
        const marcatori = [];
        const assist = [];
        const cartellini = [];
        
        Object.entries(stats.giocatori || {}).forEach(([giocatore, stat]) => {
            if (stat.gol > 0) {
                marcatori.push({
                    nome: giocatore,
                    gol: stat.gol,
                    colore: getPlayerColor(giocatore)
                });
            }
            if (stat.assist > 0) {
                assist.push({
                    nome: giocatore,
                    assist: stat.assist,
                    colore: getPlayerColor(giocatore)
                });
            }
            if (stat.gialli > 0 || stat.rossi > 0) {
                cartellini.push({
                    nome: giocatore,
                    gialli: stat.gialli,
                    rossi: stat.rossi,
                    colore: getPlayerColor(giocatore)
                });
            }
        });
        
        function formatPlayersList(players, tipo) {
            if (players.length === 0) return '';
            
            return players.map(p => {
                let badge = '';
                if (tipo === 'gol') {
                    badge = `<span class="gol-badge">${p.gol}</span>`;
                } else if (tipo === 'assist') {
                    badge = `<span class="assist-badge">${p.assist}</span>`;
                } else if (tipo === 'cartellini') {
                    let cartelliniHTML = '';
                    if (p.gialli > 0) {
                        cartelliniHTML += `<span class="giallo-badge">${p.gialli}G</span>`;
                    }
                    if (p.rossi > 0) {
                        cartelliniHTML += `<span class="rosso-badge">${p.rossi}R</span>`;
                    }
                    badge = cartelliniHTML;
                }
                
                return `<span class="player-colored" style="background-color: ${p.colore};">
                    ${p.nome} ${badge}
                </span>`;
            }).join(', ');
        }
        
        const card = document.createElement('div');
        card.className = 'risultato-card';
        card.style.borderLeftColor = partita.completata ? '#27ae60' : '#0c2461';
        
        const dataFormattata = new Date(partita.data).toLocaleDateString('it-IT', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        card.innerHTML = `
            <div style="margin-bottom: 15px;">
                <h4 style="color: #0c2461; margin-bottom: 5px;">
                    <span class="team-colored" style="background-color: ${partita.coloreCasa};">
                        ${partita.nomeCasa}
                    </span>
                    <span class="risultato-numero">${partita.golCasa}</span>
                    <span style="font-size: 20px; color: #666;">-</span>
                    <span class="risultato-numero">${partita.golTrasferta}</span>
                    <span class="team-colored" style="background-color: ${partita.coloreTrasferta};">
                        ${partita.nomeTrasferta}
                    </span>
                </h4>
                <div style="color: #666; font-size: 14px;">
                    <i class="fas fa-calendar-day"></i> ${dataFormattata}
                    <span style="margin-left: 15px;">
                        <i class="fas fa-flag"></i> Giornata ${partita.giornata}
                    </span>
                </div>
            </div>
            
            ${marcatori.length > 0 ? `
                <div style="margin-bottom: 10px;">
                    <strong><i class="fas fa-futbol"></i> Marcatori:</strong>
                    <div style="color: #666; font-size: 14px; margin-top: 5px;">
                        ${formatPlayersList(marcatori, 'gol')}
                    </div>
                </div>
            ` : ''}
            
            ${assist.length > 0 ? `
                <div style="margin-bottom: 10px;">
                    <strong><i class="fas fa-handshake"></i> Assist:</strong>
                    <div style="color: #666; font-size: 14px; margin-top: 5px;">
                        ${formatPlayersList(assist, 'assist')}
                    </div>
                </div>
            ` : ''}
            
            ${cartellini.length > 0 ? `
                <div style="margin-bottom: 10px;">
                    <strong><i class="fas fa-square"></i> Cartellini:</strong>
                    <div style="color: #666; font-size: 14px; margin-top: 5px;">
                        ${formatPlayersList(cartellini, 'cartellini')}
                    </div>
                </div>
            ` : ''}
            
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="inserisciRisultato(${partita.id})" class="btn-primary" style="flex: 1;">
                    <i class="fas fa-edit"></i> Modifica Risultato
                </button>
                <button onclick="visualizzaStatistichePartita(${partita.id})" class="btn-secondary" style="flex: 1;">
                    <i class="fas fa-chart-bar"></i> Dettagli Statistiche
                </button>
            </div>
        `;
        
        risultatiGrid.appendChild(card);
    });
    
    container.appendChild(risultatiGrid);
}

function aggiornaStatistica(giocatore, tipo, valore) {
    if (!database.currentPartitaModifica) return;
    
    const partitaId = database.currentPartitaModifica;
    if (!database.statistichePartite[partitaId]) {
        database.statistichePartite[partitaId] = { giocatori: {} };
    }
    
    if (!database.statistichePartite[partitaId].giocatori[giocatore]) {
        database.statistichePartite[partitaId].giocatori[giocatore] = {
            gol: 0, assist: 0, gialli: 0, rossi: 0
        };
    }
    
    const numValore = parseInt(valore) || 0;
    
    if (tipo === 'gialli' && numValore > 2) {
        database.statistichePartite[partitaId].giocatori[giocatore][tipo] = 2;
        alert('Un giocatore non può avere più di 2 ammonizioni!');
        return;
    }
    
    if (tipo === 'rossi' && numValore > 1) {
        database.statistichePartite[partitaId].giocatori[giocatore][tipo] = 1;
        alert('Un giocatore non può avere più di 1 espulsione!');
        return;
    }
    
    database.statistichePartite[partitaId].giocatori[giocatore][tipo] = numValore;
}

function visualizzaStatistichePartita(partitaId) {
    const partita = database.partite.find(p => p.id === partitaId);
    if (!partita || !partita.completata) return;
    
    const stats = database.statistichePartite[partitaId];
    if (!stats) {
        alert('Nessuna statistica disponibile per questa partita');
        return;
    }
    
    const modalContent = document.getElementById('risultatiModalContent');
    
    function creaStatisticheDettagliate(squadraId, squadraNome, squadraColore) {
        const squadra = database.squadre.find(s => s.id === squadraId);
        if (!squadra) return '';
        
        let html = `<h4><span class="team-colored" style="background-color: ${squadraColore};">${squadraNome}</span></h4>`;
        const giocatoriSquadra = Object.keys(stats.giocatori || {}).filter(g => 
            database.playerSquadra[g] === squadraId
        );
        
        if (giocatoriSquadra.length === 0) {
            html += '<p style="color: #888; font-style: italic;">Nessuna statistica</p>';
            return html;
        }
        
        html += '<div class="stats-grid">';
        
        giocatoriSquadra.forEach(giocatore => {
            const s = stats.giocatori[giocatore];
            const totaleGol = s.gol || 0;
            const totaleAssist = s.assist || 0;
            const totaleGialli = s.gialli || 0;
            const totaleRossi = s.rossi || 0;
            
            if (totaleGol === 0 && totaleAssist === 0 && totaleGialli === 0 && totaleRossi === 0) {
                return;
            }
            
            const playerColor = getPlayerColor(giocatore);
            const isCaptain = squadra && squadra.capitano === giocatore;
            const isGoalkeeper = squadra && squadra.portiere === giocatore;
            
            html += `
                <div class="stats-card" style="border-left-color: ${playerColor};">
                    <h5 style="margin-bottom: 10px;">
                        <span class="player-colored" style="background-color: ${playerColor};">
                            ${giocatore}
                            ${isCaptain ? ' <span class="captain-badge">(C)</span>' : ''}
                            ${isGoalkeeper ? ' <span class="portiere-badge">(P)</span>' : ''}
                        </span>
                    </h5>
                    
                    ${totaleGol > 0 ? `
                        <div style="margin-bottom: 5px;">
                            <span class="stat-badge gol-badge">
                                <i class="fas fa-futbol"></i> ${totaleGol} Gol
                            </span>
                        </div>
                    ` : ''}
                    
                    ${totaleAssist > 0 ? `
                        <div style="margin-bottom: 5px;">
                            <span class="stat-badge assist-badge">
                                <i class="fas fa-handshake"></i> ${totaleAssist} Assist
                            </span>
                        </div>
                    ` : ''}
                    
                    ${totaleGialli > 0 ? `
                        <div style="margin-bottom: 5px;">
                            <span class="stat-badge giallo-badge">
                                <i class="fas fa-square"></i> ${totaleGialli} Ammonizioni
                            </span>
                        </div>
                    ` : ''}
                    
                    ${totaleRossi > 0 ? `
                        <div style="margin-bottom: 5px;">
                            <span class="stat-badge rosso-badge">
                                <i class="fas fa-square"></i> ${totaleRossi} Espulsioni
                            </span>
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        html += '</div>';
        return html;
    }
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3><i class="fas fa-chart-bar"></i> Statistiche Partita</h3>
            <button class="close-modal" onclick="chiudiModale('risultatiModal')">&times;</button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h4 style="color: #0c2461; margin-bottom: 10px;">
                <i class="fas fa-futbol"></i> 
                <span class="team-colored" style="background-color: ${partita.coloreCasa};">
                    ${partita.nomeCasa}
                </span>
                <span style="margin: 0 10px;">${partita.golCasa} - ${partita.golTrasferta}</span>
                <span class="team-colored" style="background-color: ${partita.coloreTrasferta};">
                    ${partita.nomeTrasferta}
                </span>
            </h4>
            <div style="color: #666;">
                Giornata ${partita.giornata} - ${new Date(partita.data).toLocaleDateString('it-IT')}
            </div>
        </div>
        
        <div>
            ${creaStatisticheDettagliate(partita.squadraCasa, partita.nomeCasa, partita.coloreCasa)}
            
            <hr style="margin: 20px 0;">
            
            ${creaStatisticheDettagliate(partita.squadraTrasferta, partita.nomeTrasferta, partita.coloreTrasferta)}
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
            <button onclick="chiudiModale('risultatiModal')" class="btn-primary">
                <i class="fas fa-times"></i> Chiudi
            </button>
        </div>
    `;
    
    document.getElementById('risultatiModal').style.display = 'flex';
}

function eliminaPartita(partitaId) {
    if (!database.isAdmin) {
        alert('Solo gli amministratori possono eliminare partite!');
        return;
    }
    
    if (!confirm('Sei sicuro di voler eliminare questa partita?')) return;
    
    database.partite = database.partite.filter(p => p.id !== partitaId);
    delete database.statistichePartite[partitaId];
    saveToLocalStorage();
    updatePartiteView();
    updateRisultatiView();
    alert('Partita eliminata con successo!');
}

function chiudiModale(modalId) {
    document.getElementById(modalId).style.display = 'none';
    database.currentPartitaModifica = null;
}

function updateAdminSection() {
    const adminSection = document.getElementById('adminOnlySection');
    if (adminSection) {
        adminSection.style.display = database.isAdmin ? 'block' : 'none';
    }
}

// ====================
// CLASSIFICHE AUTOMATICHE
// ====================

function calcolaClassificaGiocatori(tipo) {
    const statsGiocatori = {};
    
    database.players.forEach(giocatore => {
        const squadraId = database.playerSquadra[giocatore];
        const squadra = database.squadre.find(s => s.id === squadraId);
        const isCaptain = squadra && squadra.capitano === giocatore;
        const isGoalkeeper = squadra && squadra.portiere === giocatore;
        
        statsGiocatori[giocatore] = {
            nome: giocatore,
            gol: 0,
            assist: 0,
            gialli: 0,
            rossi: 0,
            squadra: squadra ? squadra.nome : 'Nessuna',
            coloreSquadra: squadra ? squadra.colore : '#666666',
            capitano: isCaptain,
            portiere: isGoalkeeper
        };
    });
    
    Object.values(database.statistichePartite).forEach(statsPartita => {
        Object.entries(statsPartita.giocatori || {}).forEach(([giocatore, stat]) => {
            if (statsGiocatori[giocatore]) {
                statsGiocatori[giocatore].gol += stat.gol || 0;
                statsGiocatori[giocatore].assist += stat.assist || 0;
                statsGiocatori[giocatore].gialli += stat.gialli || 0;
                statsGiocatori[giocatore].rossi += stat.rossi || 0;
            }
        });
    });
    
    let giocatoriArray = Object.values(statsGiocatori);
    
    switch(tipo) {
        case 'marcatori':
            return giocatoriArray
                .filter(g => g.gol > 0)
                .sort((a, b) => b.gol - a.gol);
                
        case 'assist':
            return giocatoriArray
                .filter(g => g.assist > 0)
                .sort((a, b) => b.assist - a.assist);
                
        case 'cartellini':
            return giocatoriArray
                .filter(g => g.gialli > 0 || g.rossi > 0)
                .sort((a, b) => {
                    if (b.rossi !== a.rossi) return b.rossi - a.rossi;
                    return b.gialli - a.gialli;
                });
                
        default:
            return [];
    }
}

function showClassifica(tipo) {
    const container = document.getElementById('classifiche-container');
    
    switch(tipo) {
        case 'squadre':
            const classificaSquadre = calcolaClassificaSquadre();
            
            let htmlSquadre = `
                <h3><i class="fas fa-trophy"></i> Classifica Squadre</h3>
                <p style="color: #666; margin-bottom: 10px;">Vittoria: 3 punti • Pareggio: 1 punto • Sconfitta: 0 punti</p>
                <table class="classifica-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Squadra</th>
                            <th>PG</th>
                            <th>V</th>
                            <th>P</th>
                            <th>S</th>
                            <th>GF</th>
                            <th>GS</th>
                            <th>DR</th>
                            <th>Punti</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            classificaSquadre.forEach((squadra, index) => {
                const posClass = index === 0 ? 'posizione-1' : 
                               index === 1 ? 'posizione-2' : 
                               index === 2 ? 'posizione-3' : '';
                
                htmlSquadre += `
                    <tr>
                        <td class="posizione ${posClass}">${index + 1}°</td>
                        <td>
                            <strong>
                                <span style="display: inline-block; width: 12px; height: 12px; background-color: ${squadra.colore}; border-radius: 50%; margin-right: 8px;"></span>
                                ${squadra.nome}
                            </strong>
                        </td>
                        <td>${squadra.partiteGiocate}</td>
                        <td>${squadra.vinte}</td>
                        <td>${squadra.pareggiate}</td>
                        <td>${squadra.perse}</td>
                        <td>${squadra.golFatti}</td>
                        <td>${squadra.golSubiti}</td>
                        <td>${squadra.golFatti - squadra.golSubiti}</td>
                        <td><strong>${squadra.punti}</strong></td>
                    </tr>
                `;
            });
            
            htmlSquadre += '</tbody></table>';
            container.innerHTML = htmlSquadre;
            break;
            
        case 'marcatori':
            const marcatori = calcolaClassificaGiocatori('marcatori');
            
            let htmlMarcatori = `
                <h3><i class="fas fa-futbol"></i> Classifica Marcatori</h3>
            `;
            
            if (marcatori.length === 0) {
                htmlMarcatori += `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                        <i class="fas fa-futbol fa-3x" style="color: #ddd; margin-bottom: 15px;"></i>
                        <p>Nessun gol segnato ancora</p>
                    </div>
                `;
            } else {
                htmlMarcatori += `
                    <table class="classifica-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Giocatore</th>
                                <th>Squadra</th>
                                <th>Gol</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                marcatori.forEach((giocatore, index) => {
                    const posClass = index === 0 ? 'posizione-1' : 
                                   index === 1 ? 'posizione-2' : 
                                   index === 2 ? 'posizione-3' : '';
                    
                    htmlMarcatori += `
                        <tr>
                            <td class="posizione ${posClass}">${index + 1}°</td>
                            <td>
                                <strong>
                                    <span class="player-colored" style="background-color: ${giocatore.coloreSquadra};">
                                        ${giocatore.nome}
                                        ${giocatore.capitano ? ' <span class="captain-badge">(C)</span>' : ''}
                                        ${giocatore.portiere ? ' <span class="portiere-badge">(P)</span>' : ''}
                                    </span>
                                </strong>
                            </td>
                            <td>
                                <span style="display: inline-block; width: 10px; height: 10px; background-color: ${giocatore.coloreSquadra}; border-radius: 50%; margin-right: 5px;"></span>
                                ${giocatore.squadra}
                            </td>
                            <td><strong>${giocatore.gol}</strong></td>
                        </tr>
                    `;
                });
                
                htmlMarcatori += '</tbody></table>';
            }
            
            container.innerHTML = htmlMarcatori;
            break;
            
        case 'assist':
            const assist = calcolaClassificaGiocatori('assist');
            
            let htmlAssist = `
                <h3><i class="fas fa-handshake"></i> Classifica Assist</h3>
            `;
            
            if (assist.length === 0) {
                htmlAssist += `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                        <i class="fas fa-handshake fa-3x" style="color: #ddd; margin-bottom: 15px;"></i>
                        <p>Nessun assist registrato ancora</p>
                    </div>
                `;
            } else {
                htmlAssist += `
                    <table class="classifica-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Giocatore</th>
                                <th>Squadra</th>
                                <th>Assist</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                assist.forEach((giocatore, index) => {
                    const posClass = index === 0 ? 'posizione-1' : 
                                   index === 1 ? 'posizione-2' : 
                                   index === 2 ? 'posizione-3' : '';
                    
                    htmlAssist += `
                        <tr>
                            <td class="posizione ${posClass}">${index + 1}°</td>
                            <td>
                                <strong>
                                    <span class="player-colored" style="background-color: ${giocatore.coloreSquadra};">
                                        ${giocatore.nome}
                                        ${giocatore.capitano ? ' <span class="captain-badge">(C)</span>' : ''}
                                        ${giocatore.portiere ? ' <span class="portiere-badge">(P)</span>' : ''}
                                    </span>
                                </strong>
                            </td>
                            <td>
                                <span style="display: inline-block; width: 10px; height: 10px; background-color: ${giocatore.coloreSquadra}; border-radius: 50%; margin-right: 5px;"></span>
                                ${giocatore.squadra}
                            </td>
                            <td><strong>${giocatore.assist}</strong></td>
                        </tr>
                    `;
                });
                
                htmlAssist += '</tbody></table>';
            }
            
            container.innerHTML = htmlAssist;
            break;
            
        case 'cartellini':
            const cartellini = calcolaClassificaGiocatori('cartellini');
            
            let htmlCartellini = `
                <h3><i class="fas fa-square"></i> Classifica Cartellini</h3>
                <p style="color: #666; margin-bottom: 10px;">Ordine: Espulsioni (rossi) → Ammonizioni (gialli)</p>
            `;
            
            if (cartellini.length === 0) {
                htmlCartellini += `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                        <i class="fas fa-square fa-3x" style="color: #ddd; margin-bottom: 15px;"></i>
                        <p>Nessun cartellino assegnato ancora</p>
                    </div>
                `;
            } else {
                htmlCartellini += `
                    <table class="classifica-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Giocatore</th>
                                <th>Squadra</th>
                                <th>Gialli</th>
                                <th>Rossi</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                cartellini.forEach((giocatore, index) => {
                    htmlCartellini += `
                        <tr>
                            <td class="posizione">${index + 1}°</td>
                            <td>
                                <strong>
                                    <span class="player-colored" style="background-color: ${giocatore.coloreSquadra};">
                                        ${giocatore.nome}
                                        ${giocatore.capitano ? ' <span class="captain-badge">(C)</span>' : ''}
                                        ${giocatore.portiere ? ' <span class="portiere-badge">(P)</span>' : ''}
                                    </span>
                                </strong>
                            </td>
                            <td>
                                <span style="display: inline-block; width: 10px; height: 10px; background-color: ${giocatore.coloreSquadra}; border-radius: 50%; margin-right: 5px;"></span>
                                ${giocatore.squadra}
                            </td>
                            <td>${giocatore.gialli}</td>
                            <td>${giocatore.rossi}</td>
                        </tr>
                    `;
                });
                
                htmlCartellini += '</tbody></table>';
            }
            
            container.innerHTML = htmlCartellini;
            break;
    }
}

// ====================
// PWA - INSTALLAZIONE
// ====================

// 1. REGISTRA SERVICE WORKER
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    const swCode = `
self.addEventListener('install', function(event) {
  console.log('Service Worker installato');
  event.waitUntil(self.skipWaiting());
});

self.addEventListener('activate', function(event) {
  console.log('Service Worker attivato');
  event.waitUntil(self.clients.claim());
});

self.addEventListener('fetch', function(event) {
  event.respondWith(
    caches.match(event.request).then(function(response) {
      return response || fetch(event.request);
    })
  );
});
`;
    
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swURL = URL.createObjectURL(blob);
    
    navigator.serviceWorker.register(swURL)
      .then(function(registration) {
        console.log('✅ Service Worker registrato:', registration.scope);
      })
      .catch(function(err) {
        console.log('❌ Service Worker errore:', err);
      });
  });
}

// 2. PULSANTE INSTALLA APP
let deferredPrompt;
const installButton = document.createElement('button');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  installButton.innerHTML = '<i class="fas fa-download"></i> Installa App';
  installButton.style.cssText = `
    position: fixed; bottom: 20px; right: 20px;
    background: #0c2461; color: white; padding: 12px 20px;
    border: none; border-radius: 25px; cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;
    font-size: 16px; display: flex; align-items: center; gap: 8px;
  `;
  
  installButton.onclick = () => {
    installButton.style.display = 'none';
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        console.log('✅ App installata!');
        localStorage.setItem('pwaInstalled', 'true');
      }
      deferredPrompt = null;
    });
  };
  
  setTimeout(() => {
    if (deferredPrompt && !localStorage.getItem('pwaInstalled')) {
      document.body.appendChild(installButton);
    }
  }, 10000);
});

// 3. CONTROLLA SE IN MODALITÀ APP
function checkPWA() {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
  const isiOSPWA = window.navigator.standalone === true;
  
  if (isStandalone || isiOSPWA) {
    document.documentElement.classList.add('pwa-mode');
    
    const splash = document.getElementById('splash-screen');
    if (splash) {
      splash.style.display = 'flex';
      setTimeout(() => {
        splash.style.display = 'none';
      }, 2000);
    }
    
    if (installButton.parentNode) {
      installButton.style.display = 'none';
    }
  }
}

// Esegui al caricamento
checkPWA();

// 4. Crea manifest.json dinamicamente
function createManifest() {
    const manifest = {
        "name": "Campionato Arena 2026",
        "short_name": "Arena 2026",
        "description": "Gestione del campionato calcistico Arena 2026",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#0c2461",
        "theme_color": "#0c2461",
        "orientation": "portrait",
        "icons": [
            {
                "src": "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/shield-alt.svg",
                "sizes": "192x192",
                "type": "image/svg+xml"
            },
            {
                "src": "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/shield-alt.svg",
                "sizes": "512x512",
                "type": "image/svg+xml"
            }
        ]
    };
    
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = 'data:application/json,' + encodeURIComponent(JSON.stringify(manifest));
    document.head.appendChild(link);
}

createManifest();
</script>

</body>
</html>