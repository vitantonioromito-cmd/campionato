<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèÜ Campionato Arena</title>
<style>
/* TUTTO IL CSS RIMANE IDENTICO */
:root {
  --bg: #0a192f;
  --card: #112240;
  --accent: #00d4aa;
  --accent-dark: #00b894;
  --text: #e6f1ff;
  --muted: #8892b0;
  --success: #00d4aa;
  --warning: #ffd166;
  --danger: #ef476f;
  --blue: #118ab2;
  --purple: #9d4edd;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  margin: 0;
  font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

/* Login Screen */
.login-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  background-image: radial-gradient(circle at 20% 80%, rgba(0, 212, 170, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(17, 138, 178, 0.1) 0%, transparent 50%);
}

.login-card {
  background: rgba(17, 34, 64, 0.9);
  backdrop-filter: blur(10px);
  padding: 40px 30px;
  border-radius: 24px;
  width: 90%;
  max-width: 400px;
  border: 1px solid rgba(0, 212, 170, 0.2);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  text-align: center;
}

.login-logo {
  font-size: 48px;
  margin-bottom: 10px;
}

.login-card h2 {
  margin-bottom: 30px;
  font-weight: 700;
  font-size: 28px;
  color: var(--text);
}

.login-card input {
  width: 100%;
  padding: 16px 20px;
  border-radius: 12px;
  border: 2px solid rgba(136, 146, 176, 0.3);
  background: rgba(10, 25, 47, 0.8);
  color: var(--text);
  font-size: 16px;
  margin-bottom: 20px;
  transition: all 0.3s ease;
}

.login-card input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
}

.login-card button {
  width: 100%;
  padding: 16px;
  border-radius: 12px;
  border: none;
  background: var(--accent);
  color: black;
  font-weight: 900;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 10px;
}

.login-card button:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(0, 212, 170, 0.3);
}

.login-hint {
  font-size: 13px;
  color: var(--muted);
  margin-top: 20px;
  line-height: 1.5;
}

/* Header */
header {
  background: linear-gradient(90deg, #008C45, #F4F5F0, #CD212A);
  padding: 16px 20px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 480px;
  margin: 0 auto;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

#liveIndicator {
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 6px;
  animation: pulse 2s infinite;
}

#liveIndicator::before {
  content: "";
  width: 8px;
  height: 8px;
  background: #00d4aa;
  border-radius: 50%;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.header-title {
  font-size: 20px;
  font-weight: 900;
  color: black;
}

.user-badge {
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 6px;
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.user-role {
  font-size: 10px;
  opacity: 0.8;
  margin-left: 4px;
}

/* Navigation */
.nav {
  display: flex;
  background: #081724;
  overflow-x: auto;
  position: sticky;
  top: 71px;
  z-index: 99;
  border-bottom: 1px solid rgba(136, 146, 176, 0.1);
  scrollbar-width: none;
}

.nav::-webkit-scrollbar {
  display: none;
}

.nav button {
  flex: 1;
  min-width: 80px;
  padding: 16px 8px;
  border: none;
  background: transparent;
  color: var(--muted);
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.nav button .nav-icon {
  font-size: 18px;
}

.nav button.active {
  color: var(--accent);
  background: rgba(0, 212, 170, 0.1);
  border-bottom: 3px solid var(--accent);
}

/* Main Content */
main {
  max-width: 480px;
  margin: 0 auto;
  padding: 20px;
  padding-bottom: 100px;
}

.section {
  display: none;
  animation: fadeIn 0.3s ease;
}

.section.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Cards */
.card {
  background: var(--card);
  border-radius: 20px;
  padding: 24px;
  margin-bottom: 20px;
  border: 1px solid rgba(136, 146, 176, 0.1);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.card:hover {
  border-color: rgba(0, 212, 170, 0.3);
  transform: translateY(-2px);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.card::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--accent);
}

.card h3 {
  margin-bottom: 20px;
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Form Elements */
input, select, button {
  width: 100%;
  padding: 16px;
  border-radius: 12px;
  border: 2px solid rgba(136, 146, 176, 0.3);
  background: rgba(10, 25, 47, 0.8);
  color: var(--text);
  font-size: 16px;
  margin-bottom: 16px;
  transition: all 0.3s ease;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
}

button {
  background: var(--accent);
  color: black;
  border: none;
  font-weight: 900;
  font-size: 16px;
  cursor: pointer;
  padding: 16px;
  transition: all 0.3s ease;
  margin-bottom: 0;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(0, 212, 170, 0.3);
}

button.secondary {
  background: rgba(136, 146, 176, 0.2);
  color: var(--text);
}

button.secondary:hover {
  background: rgba(136, 146, 176, 0.3);
  box-shadow: 0 10px 30px rgba(136, 146, 176, 0.1);
}

button.danger {
  background: var(--danger);
  color: white;
}

button.danger:hover {
  box-shadow: 0 10px 30px rgba(239, 71, 111, 0.3);
}

/* Teams Section */
.palette {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin: 20px 0;
  justify-content: center;
}

.colorPick {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 3px solid transparent;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.colorPick:hover {
  transform: scale(1.1);
}

.colorPick.active {
  border-color: white;
  box-shadow: 0 0 0 3px var(--accent), 0 4px 20px rgba(0, 212, 170, 0.3);
}

.teamCard {
  background: rgba(10, 25, 47, 0.8);
  border-radius: 18px;
  padding: 24px;
  margin-bottom: 20px;
  border-left: 8px solid;
  position: relative;
  overflow: hidden;
}

.teamCard::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(0, 212, 170, 0.3), transparent);
}

.teamCard h3 {
  font-size: 22px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.team-color {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: inline-block;
}

.player {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px;
  margin: 8px 0;
  background: rgba(17, 34, 64, 0.8);
  border-radius: 12px;
  border-left: 4px solid;
  transition: all 0.3s ease;
}

.player:hover {
  background: rgba(0, 212, 170, 0.1);
  transform: translateX(5px);
}

.player-info {
  flex: 1;
}

.player-name {
  font-weight: 600;
  font-size: 15px;
}

.player-role {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}

.player-stats {
  display: flex;
  gap: 12px;
  align-items: center;
}

.stat-bubble {
  background: rgba(0, 212, 170, 0.1);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Matches Section */
.match-card {
  background: rgba(10, 25, 47, 0.8);
  border-radius: 18px;
  padding: 24px;
  margin-bottom: 20px;
  border: 1px solid rgba(136, 146, 176, 0.1);
  position: relative;
}

.match-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.match-date {
  font-size: 15px;
  font-weight: 600;
  color: var(--muted);
}

.match-creator {
  font-size: 12px;
  background: rgba(136, 146, 176, 0.2);
  padding: 4px 12px;
  border-radius: 20px;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.match-teams {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.team-display {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
}

.team-name {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}

.team-badge {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  margin-bottom: 10px;
}

.vs-divider {
  font-size: 14px;
  color: var(--muted);
  margin: 0 20px;
  font-weight: 700;
}

.match-score {
  font-size: 48px;
  font-weight: 900;
  text-align: center;
  margin: 20px 0;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  background: rgba(0, 212, 170, 0.05);
  padding: 20px;
  border-radius: 16px;
}

.score-input-container {
  display: flex;
  gap: 30px;
  align-items: center;
  justify-content: center;
  margin: 30px 0;
}

.score-input {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.score-input input {
  width: 100px;
  height: 100px;
  font-size: 48px;
  font-weight: 900;
  text-align: center;
  border: 3px solid rgba(136, 146, 176, 0.3);
  background: rgba(10, 25, 47, 0.8);
  border-radius: 20px;
  color: var(--text);
}

.score-input input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 5px rgba(0, 212, 170, 0.1);
}

.score-divider {
  font-size: 36px;
  color: var(--muted);
  font-weight: 900;
}

.score-label {
  font-size: 14px;
  color: var(--muted);
  font-weight: 600;
}

.match-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.match-actions button {
  flex: 1;
}

/* CLASSIFICA */
.standing-header {
  display: flex;
  background: rgba(0, 212, 170, 0.1);
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 10px;
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.standing-pos-header {
  width: 40px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.standing-team-header {
  flex: 1;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.standing-stats-header {
  display: flex;
  justify-content: space-between;
  width: 280px;
}

.standing-stat-header {
  width: 30px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.standing-points-header {
  width: 50px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.standing-row {
  display: flex;
  align-items: center;
  padding: 18px 16px;
  margin: 8px 0;
  background: rgba(17, 34, 64, 0.8);
  border-radius: 16px;
  transition: all 0.3s ease;
  border-left: 4px solid;
}

.standing-row:hover {
  background: rgba(0, 212, 170, 0.1);
  transform: translateX(5px);
}

.standing-pos {
  width: 40px;
  text-align: center;
  font-weight: 900;
  font-size: 18px;
  color: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
}

.standing-team {
  flex: 1;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0 10px;
}

.standing-team-name {
  font-weight: 700;
  font-size: 16px;
  margin-bottom: 4px;
}

.standing-stats {
  display: flex;
  justify-content: space-between;
  width: 280px;
}

.standing-stat {
  width: 30px;
  text-align: center;
  font-weight: 700;
  font-size: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.standing-points {
  width: 50px;
  text-align: center;
  font-weight: 900;
  font-size: 20px;
  color: var(--accent);
  background: rgba(0, 212, 170, 0.1);
  padding: 8px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Statistics */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin-top: 20px;
}

.stat-card-mini {
  background: rgba(17, 34, 64, 0.8);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  border: 1px solid rgba(136, 146, 176, 0.1);
  transition: all 0.3s ease;
}

.stat-card-mini:hover {
  border-color: var(--accent);
  transform: translateY(-3px);
}

.stat-icon {
  font-size: 28px;
  margin-bottom: 12px;
}

.stat-value {
  font-size: 32px;
  font-weight: 900;
  margin: 10px 0;
  color: var(--accent);
}

.stat-label {
  font-size: 13px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Events */
.event {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  margin: 10px 0;
  background: rgba(17, 34, 64, 0.8);
  border-radius: 14px;
  border-left: 6px solid;
  transition: all 0.3s ease;
}

.event:hover {
  background: rgba(0, 212, 170, 0.1);
}

.event-info {
  flex: 1;
}

.event-player {
  font-weight: 700;
  font-size: 15px;
  margin-bottom: 4px;
}

.event-details {
  font-size: 13px;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 8px;
}

.event-meta {
  text-align: right;
}

.event-admin {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.event-time {
  font-size: 11px;
  color: var(--muted);
  opacity: 0.7;
}

/* My Score */
.my-score-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin: 25px 0;
}

.my-stat-card {
  background: rgba(17, 34, 64, 0.8);
  border-radius: 18px;
  padding: 25px 20px;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.my-stat-card::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--accent);
}

.my-stat-value {
  font-size: 42px;
  font-weight: 900;
  margin: 15px 0;
  color: var(--text);
}

.my-stat-label {
  font-size: 14px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Backup */
.backup-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin: 25px 0;
}

.backup-card {
  background: rgba(17, 34, 64, 0.8);
  border-radius: 18px;
  padding: 25px 20px;
  text-align: center;
  border: 1px solid rgba(136, 146, 176, 0.1);
}

.backup-value {
  font-size: 32px;
  font-weight: 900;
  margin: 15px 0;
  color: var(--accent);
}

.backup-label {
  font-size: 13px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Sync Status */
.sync-status {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--accent);
  color: black;
  padding: 16px;
  text-align: center;
  font-size: 14px;
  font-weight: 900;
  z-index: 101;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  box-shadow: 0 -5px 30px rgba(0, 212, 170, 0.3);
}

.sync-status.error {
  background: var(--danger);
  color: white;
}

/* Modal */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  backdrop-filter: blur(5px);
}

.modal-content {
  background: var(--card);
  padding: 30px;
  border-radius: 20px;
  max-width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  border: 1px solid rgba(0, 212, 170, 0.2);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
}

.modal-close {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 24px;
  cursor: pointer;
  width: auto;
  padding: 0;
}

.modal-close:hover {
  color: var(--accent);
  background: none;
  transform: none;
  box-shadow: none;
}

.modal-body {
  margin-bottom: 20px;
}

/* Toast Notifications */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 3000;
}

.toast {
  background: var(--card);
  border-left: 4px solid var(--accent);
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
  animation: slideInRight 0.3s ease;
  max-width: 300px;
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.toast-success {
  border-left-color: var(--success);
}

.toast-warning {
  border-left-color: var(--warning);
}

.toast-error {
  border-left-color: var(--danger);
}

.toast-icon {
  font-size: 20px;
}

.toast-message {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
}

.toast-close {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 4px;
}

.toast-close:hover {
  color: var(--text);
}

/* Empty States */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.empty-icon {
  font-size: 60px;
  margin-bottom: 20px;
  opacity: 0.3;
}

.empty-text {
  font-size: 16px;
  line-height: 1.6;
}

/* Animations */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.slide-in {
  animation: slideIn 0.3s ease;
}

.slide-up {
  animation: slideUp 0.3s ease;
}

/* Badges */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  margin-left: 10px;
}

.status-badge.completed {
  background: rgba(0, 212, 170, 0.1);
  color: var(--success);
}

.status-badge.pending {
  background: rgba(255, 209, 102, 0.1);
  color: var(--warning);
}
</style>
</head>
<body>
<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <div class="login-logo">üèÜ</div>
    <h2>Campionato Arena</h2>
    <input type="text" id="loginUsername" placeholder="Il tuo nome" autocomplete="off">
    <input type="password" id="loginPassword" placeholder="Password admin" style="display:none" autocomplete="off">
    <button onclick="checkLogin()">ENTRA NEL CAMPIONATO</button>
    <div class="login-hint">
      Inserisci il tuo nome per entrare.<br>
      Se sei un admin, inserisci anche la password.
    </div>
  </div>
</div>

<!-- Main App -->
<div id="app" style="display:none">
  <!-- Header -->
  <header>
    <div class="header-content">
      <div class="header-left">
        <div id="liveIndicator">LIVE</div>
        <div class="header-title">Campionato Arena</div>
      </div>
      <div class="user-badge" id="userBadge">
        <span id="userIcon">üë§</span>
        <span id="userName"></span>
        <span id="userRole" class="user-role"></span>
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <div class="nav">
    <button class="active" onclick="openTab('squadre',this)">
      <span class="nav-icon">üë•</span>
      <span>Squadre</span>
    </button>
    <button onclick="openTab('cal',this)">
      <span class="nav-icon">üìÖ</span>
      <span>Partite</span>
    </button>
    <button onclick="openTab('class',this)">
      <span class="nav-icon">üèÜ</span>
      <span>Classifica</span>
    </button>
    <button onclick="openTab('stats',this)">
      <span class="nav-icon">‚≠ê</span>
      <span>Statistiche</span>
    </button>
    <button onclick="openTab('myscore',this)">
      <span class="nav-icon">üë§</span>
      <span>Il Mio Score</span>
    </button>
    <button onclick="openTab('backup',this)">
      <span class="nav-icon">üíæ</span>
      <span>Backup</span>
    </button>
    <button onclick="logout()">
      <span class="nav-icon">üö™</span>
      <span>Esci</span>
    </button>
  </div>

  <!-- Main Content -->
  <main>
    <!-- Squadre -->
    <section id="squadre" class="section active">
      <div class="card" id="createTeamCard" style="display:none">
        <h3>‚ûï Crea Nuova Squadra</h3>
        <input id="teamName" placeholder="Nome squadra">
        <div>Scegli colore:</div>
        <div class="palette" id="palette"></div>
        <button onclick="addTeam()">CREA SQUADRA</button>
      </div>
      <div id="teams"></div>
    </section>

    <!-- Partite -->
    <section id="cal" class="section">
      <div class="card" id="createMatchCard" style="display:none">
        <h3>‚ûï Nuova Partita</h3>
        <input type="date" id="matchDate">
        <input type="time" id="matchTime">
        <select id="homeTeam"></select>
        <select id="awayTeam"></select>
        <button onclick="addMatch()">CREA PARTITA</button>
      </div>
      <div id="matches"></div>
      <div id="tabellino" class="card" style="display:none"></div>
    </section>

    <!-- Classifica -->
    <section id="class" class="section">
      <div class="card">
        <h3>üèÜ Classifica Campionato</h3>
        <div class="standing-header">
          <div class="standing-pos-header">#</div>
          <div class="standing-team-header">SQUADRA</div>
          <div class="standing-stats-header">
            <div class="standing-stat-header">G</div>
            <div class="standing-stat-header">V</div>
            <div class="standing-stat-header">N</div>
            <div class="standing-stat-header">P</div>
            <div class="standing-stat-header">GF</div>
            <div class="standing-stat-header">GS</div>
            <div class="standing-points-header">PTS</div>
          </div>
        </div>
        <div id="table"></div>
      </div>
    </section>

    <!-- Statistiche -->
    <section id="stats" class="section">
      <div class="card">
        <h3>‚öΩ Classifica Marcatori</h3>
        <div id="topScorers"></div>
      </div>
      <div class="card">
        <h3>üÖ∞Ô∏è Classifica Assist</h3>
        <div id="topAssists"></div>
      </div>
      <div class="card">
        <h3>üü® Cartellini Gialli</h3>
        <div id="topYellows"></div>
      </div>
      <div class="card">
        <h3>üü• Cartellini Rossi</h3>
        <div id="topReds"></div>
      </div>
    </section>

    <!-- Il Mio Score -->
    <section id="myscore" class="section">
      <div class="card">
        <h3>üë§ Il Mio Score</h3>
        <div id="myScoreStats"></div>
      </div>
      <div class="card">
        <h3>üìù Le Mie Partite</h3>
        <div id="myMatches"></div>
      </div>
      <div id="myScoreDetails"></div>
    </section>

    <!-- Backup -->
    <section id="backup" class="section">
      <div class="card" id="backupCard" style="display:none">
        <h3>üíæ Backup & Ripristino</h3>
        <div class="backup-grid">
          <div class="backup-card">
            <div class="backup-value" id="backupTeamsCount">0</div>
            <div class="backup-label">Squadre</div>
          </div>
          <div class="backup-card">
            <div class="backup-value" id="backupMatchesCount">0</div>
            <div class="backup-label">Partite</div>
          </div>
          <div class="backup-card">
            <div class="backup-value" id="backupPlayersCount">0</div>
            <div class="backup-label">Giocatori</div>
          </div>
          <div class="backup-card">
            <div class="backup-value" id="backupEventsCount">0</div>
            <div class="backup-label">Eventi</div>
          </div>
        </div>
        <div class="match-actions">
          <button onclick="exportData()">üì§ ESPORTA</button>
          <button class="secondary" onclick="importData()">üì• IMPORT</button>
        </div>
        <div style="margin-top: 20px;">
          <button class="danger" onclick="resetData()">üóëÔ∏è RESET DATI</button>
        </div>
      </div>
      <div id="backupUserView" class="card">
        <h3>üíæ Informazioni Backup</h3>
        <div class="backup-grid">
          <div class="backup-card">
            <div class="backup-value" id="userBackupTeamsCount">0</div>
            <div class="backup-label">Squadre</div>
          </div>
          <div class="backup-card">
            <div class="backup-value" id="userBackupMatchesCount">0</div>
            <div class="backup-label">Partite</div>
          </div>
          <div class="backup-card">
            <div class="backup-value" id="userBackupPlayersCount">0</div>
            <div class="backup-label">Giocatori</div>
          </div>
          <div class="backup-card">
            <div class="backup-value" id="userBackupEventsCount">0</div>
            <div class="backup-label">Eventi</div>
          </div>
        </div>
        <div style="margin-top: 20px; padding: 20px; background: rgba(0,212,170,0.05); border-radius: 12px;">
          <div style="font-size: 14px; color: var(--muted); text-align: center;">
            Solo gli admin possono esportare/importare dati
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Sync Status -->
<div class="sync-status" id="syncStatus" style="display:none">
  <span id="syncIcon">üîÑ</span>
  <span id="syncText">Sincronizzazione in corso...</span>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Admin Modal -->
<div id="adminModal" class="modal" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">üîê Accesso Admin Richiesto</div>
      <button class="modal-close" onclick="closeAdminModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <p>Sei un admin? Inserisci la password per accedere a questa funzione.</p>
      <input type="password" id="adminPasswordInput" placeholder="Password admin" style="margin-top: 15px">
      <div class="match-actions" style="margin-top: 20px">
        <button onclick="verifyAdmin()">üîì VERIFICA</button>
        <button class="secondary" onclick="closeAdminModal()">‚ùå ANNULLA</button>
      </div>
    </div>
  </div>
</div>

<script>
// ================ VARIABILI GLOBALI ================
const COLORS = [
  '#e63946', '#f4a261', '#e9c46a', '#2a9d8f', '#118ab2',
  '#9d4edd', '#ff5d8f', '#06d6a0', '#ffd166', '#8ac926'
];

let currentUser = null;
let currentUserRole = "Giocatore";
let currentUserIcon = "üë§";
let isAdmin = false;
let teamsData = [];
let matchesData = [];
let selectedColor = COLORS[4];
let lastUpdateTime = 0;
let syncInterval = null;
let pendingAdminAction = null;
let isFirebaseConnected = false;
let passwordFieldShown = false;

// Firebase
let firebaseApp, firebaseDatabase;
let databaseRef;
let firebaseInitialized = false;

// ================ FIREBASE INIZIALIZATION ================
async function initializeFirebase() {
  try {
    // Controlla se Firebase √® gi√† stato caricato
    if (typeof firebase === 'undefined') {
      // Carica Firebase SDK (versione compatibilit√† per semplicit√†)
      await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js');
    }
    
    const firebaseConfig = {
      apiKey: "AIzaSyDZhOEHZcHELj_wy1gmCqX8-8zPQe0WcMk",
      authDomain: "campionato-arena-2026.firebaseapp.com",
      databaseURL: "https://campionato-arena-2026-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "campionato-arena-2026",
      storageBucket: "campionato-arena-2026.firebasestorage.app",
      messagingSenderId: "844668143316",
      appId: "1:844668143316:web:c72cb60c6e3513582f5d41"
    };
    
    // Inizializza Firebase (versione compat)
    firebaseApp = firebase.initializeApp(firebaseConfig);
    firebaseDatabase = firebase.database(firebaseApp);
    databaseRef = firebaseDatabase.ref('campionatoData');
    
    isFirebaseConnected = true;
    firebaseInitialized = true;
    console.log('‚úÖ Firebase inizializzato con successo!');
    return true;
  } catch (error) {
    console.error('‚ùå Errore inizializzazione Firebase:', error);
    isFirebaseConnected = false;
    showToast('‚ö†Ô∏è Modalit√† offline: i dati sono salvati solo localmente', 'warning');
    return false;
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// ================ SISTEMA DI SINCRONIZZAZIONE FIREBASE ================
function initFirebaseSync() {
  loadLocalData();
  
  if (isFirebaseConnected) {
    // Ascolta cambiamenti in tempo reale da Firebase
    databaseRef.on('value', (snapshot) => {
      const remoteData = snapshot.val();
      if (remoteData) {
        const remoteTime = remoteData.lastUpdate || 0;
        
        if (remoteTime > lastUpdateTime) {
          teamsData = remoteData.teams || [];
          matchesData = remoteData.matches || [];
          lastUpdateTime = remoteTime;
          
          renderAll();
          updateSyncStatus(`üîÑ Sync da Firebase`, true);
          
          saveLocalData();
        }
      }
    }, (error) => {
      console.error('Errore Firebase listener:', error);
      updateSyncStatus('‚ùå Errore connessione Firebase', false);
      isFirebaseConnected = false;
    });
    
    // Sincronizza periodicamente
    syncInterval = setInterval(syncData, 30000);
  } else {
    showToast('Modalit√† offline: i dati sono salvati solo localmente', 'warning');
  }
}

function saveDataToFirebase() {
  const data = {
    teams: teamsData,
    matches: matchesData,
    lastUpdate: Date.now(),
    lastUser: currentUser,
    lastUserRole: currentUserRole,
    version: '3.0-firebase'
  };
  
  saveLocalData();
  
  if (isFirebaseConnected) {
    databaseRef.set(data)
      .then(() => {
        lastUpdateTime = data.lastUpdate;
        updateSyncStatus('üíæ Salvato su Firebase & tutti i dispositivi', true);
      })
      .catch((error) => {
        console.error('Errore salvataggio Firebase:', error);
        updateSyncStatus('‚ùå Errore salvataggio Firebase', false);
      });
  } else {
    updateSyncStatus('üíæ Salvato solo localmente', true);
  }
  
  updateBackupInfo();
}

function syncData() {
  if (isFirebaseConnected) {
    // Verifica se ci sono aggiornamenti remoti
    databaseRef.once('value')
      .then((snapshot) => {
        const remoteData = snapshot.val();
        if (remoteData) {
          const remoteTime = remoteData.lastUpdate || 0;
          if (remoteTime > lastUpdateTime) {
            // Aggiorna con dati remoti
            teamsData = remoteData.teams || [];
            matchesData = remoteData.matches || [];
            lastUpdateTime = remoteTime;
            renderAll();
            saveLocalData();
            updateSyncStatus('üîÑ Sincronizzato con altri dispositivi', true);
          }
        }
      })
      .catch((error) => {
        console.error('Errore sincronizzazione:', error);
      });
  }
}

// ================ FUNZIONI GLOBALI PER L'HTML ================
async function checkLogin() {
  const usernameInput = document.getElementById('loginUsername');
  const passwordInput = document.getElementById('loginPassword');
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  
  if (!username) {
    showToast('Inserisci il tuo nome per entrare', 'warning');
    usernameInput.focus();
    return;
  }
  
  // Controlla se √® un admin
  const isAdminUser = ADMIN_USERS.includes(username);
  
  if (isAdminUser) {
    if (!passwordFieldShown) {
      passwordFieldShown = true;
      passwordInput.style.display = 'block';
      passwordInput.focus();
      showToast(`${username}, sei un admin! Inserisci la tua password.`, 'info');
      return;
    }
    
    if (!password) {
      showToast('Inserisci la password admin', 'warning');
      passwordInput.focus();
      return;
    }
    
    // Password admin (semplificata per demo)
    const adminPasswords = {
      'Vitantonio': 'giulia85',
      'Fabrizio': 'manetta26',
      'Jacopo': 'forzaroma1'
    };
    
    if (password !== adminPasswords[username]) {
      showToast('Password admin errata!', 'error');
      passwordInput.value = '';
      passwordInput.focus();
      return;
    }
    
    isAdmin = true;
    currentUser = username;
    currentUserRole = "Admin";
    currentUserIcon = "üëë";
    
  } else {
    passwordFieldShown = false;
    passwordInput.style.display = 'none';
    passwordInput.value = '';
    
    currentUser = username;
    isAdmin = false;
    
    // Cerca il giocatore nelle squadre
    let playerFound = false;
    for (const team of teamsData) {
      const player = team.players.find(p => 
        p.name.toLowerCase() === username.toLowerCase()
      );
      if (player) {
        currentUserRole = player.role;
        currentUserIcon = getRoleIcon(player.role);
        playerFound = true;
        break;
      }
    }
    
    if (!playerFound) {
      currentUserRole = "Giocatore";
      currentUserIcon = "üë§";
    }
  }
  
  localStorage.setItem('currentUser', currentUser);
  localStorage.setItem('isAdmin', isAdmin.toString());
  localStorage.setItem('currentUserRole', currentUserRole);
  localStorage.setItem('currentUserIcon', currentUserIcon);
  
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  
  updateUserBadge();
  
  // Mostra/nascondi funzioni admin
  toggleAdminFunctions();
  
  // Inizializza Firebase e sync se non √® gi√† stato fatto
  if (!firebaseInitialized) {
    await initializeFirebase();
  }
  initFirebaseSync();
  
  const welcomeMsg = isAdmin ? 
    `Admin ${currentUser} pronto per la gestione!` : 
    `Benvenuto ${currentUser}!`;
  showToast(`‚úÖ ${welcomeMsg}`, 'success');
  
  usernameInput.value = '';
  passwordInput.value = '';
  passwordInput.style.display = 'none';
  passwordFieldShown = false;
}

// ================ LISTA UTENTI ADMIN ================
const ADMIN_USERS = ['Vitantonio', 'Fabrizio', 'Jacopo'];

// ================ FUNZIONI RIMANENTI (UGUALI AL CODICE ORIGINALE) ================
function openTab(id, btn) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav button').forEach(x => x.classList.remove('active'));
  btn.classList.add('active');
  
  toggleAdminFunctions();
  
  switch(id) {
    case 'class': renderClassifica(); break;
    case 'stats': renderStats(); break;
    case 'myscore': renderMyScore(); break;
    case 'backup': renderBackup(); break;
  }
}

function logout() {
  if (confirm('Sei sicuro di voler uscire?')) {
    performLogout();
  }
}

function addTeam() {
  if (!isAdmin) {
    showAdminModal(addTeam);
    return;
  }
  
  const name = document.getElementById('teamName').value.trim();
  if (!name) {
    showToast('Inserisci il nome della squadra', 'warning');
    return;
  }
  
  if (teamsData.find(t => t.name.toLowerCase() === name.toLowerCase())) {
    showToast('Squadra gi√† esistente', 'error');
    return;
  }
  
  const newTeam = {
    id: Date.now(),
    name,
    color: selectedColor,
    players: [],
    createdBy: currentUser,
    createdAt: new Date().toLocaleString()
  };
  
  teamsData.push(newTeam);
  renderTeams();
  saveData();
  showToast(`Squadra "${name}" creata!`, 'success');
  document.getElementById('teamName').value = '';
}

function addMatch() {
  if (!isAdmin) {
    showAdminModal(addMatch);
    return;
  }
  
  const date = document.getElementById('matchDate').value;
  const time = document.getElementById('matchTime').value;
  const home = document.getElementById('homeTeam').value;
  const away = document.getElementById('awayTeam').value;
  
  if (!date || !time || !home || !away) {
    showToast('Compila tutti i campi', 'warning');
    return;
  }
  
  if (home === away) {
    showToast('Scegli squadre diverse', 'error');
    return;
  }
  
  const newMatch = {
    id: Date.now(),
    date,
    time,
    home,
    away,
    scoreHome: 0,
    scoreAway: 0,
    events: [],
    completed: false,
    createdBy: currentUser,
    createdAt: new Date().toLocaleString()
  };
  
  matchesData.push(newMatch);
  renderMatches();
  saveData();
  showToast(`Partita creata!`, 'success');
  
  document.getElementById('matchDate').value = '';
  document.getElementById('matchTime').value = '';
  document.getElementById('homeTeam').selectedIndex = 0;
  document.getElementById('awayTeam').selectedIndex = 0;
}

function closeAdminModal() {
  document.getElementById('adminModal').style.display = 'none';
  document.getElementById('adminPasswordInput').value = '';
  pendingAdminAction = null;
}

function verifyAdmin() {
  const password = document.getElementById('adminPasswordInput').value;
  
  // Password admin (semplificate per demo)
  const adminPasswords = {
    'Vitantonio': 'giulia85',
    'Fabrizio': 'manetta26',
    'Jacopo': 'forzaroma1'
  };
  
  if (adminPasswords[currentUser] && adminPasswords[currentUser] === password) {
    isAdmin = true;
    currentUserRole = "Admin";
    currentUserIcon = "üëë";
    
    localStorage.setItem('isAdmin', 'true');
    localStorage.setItem('currentUserRole', currentUserRole);
    localStorage.setItem('currentUserIcon', currentUserIcon);
    
    updateUserBadge();
    toggleAdminFunctions();
    closeAdminModal();
    
    if (pendingAdminAction) {
      pendingAdminAction();
    }
    
    showToast(`‚úÖ Accesso admin attivato per ${currentUser}!`, 'success');
  } else {
    showToast('Password admin errata!', 'error');
    document.getElementById('adminPasswordInput').value = '';
    document.getElementById('adminPasswordInput').focus();
  }
}

function exportData() {
  if (!isAdmin) {
    showAdminModal(exportData);
    return;
  }
  
  const data = {
    teams: teamsData,
    matches: matchesData,
    lastUpdate: Date.now(),
    exportedBy: currentUser,
    exportedAt: new Date().toISOString(),
    version: '3.0-firebase'
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `campionato-backup-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast(`Backup esportato! Squadre: ${teamsData.length}, Partite: ${matchesData.length}`, 'success');
}

function importData() {
  if (!isAdmin) {
    showAdminModal(importData);
    return;
  }
  
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      
      if (!data.teams || !data.matches) {
        showToast('File di backup non valido', 'error');
        return;
      }
      
      if (confirm(`Importare backup con ${data.teams.length} squadre e ${data.matches.length} partite?\n\nATTENZIONE: Sovrascriver√† tutti i dati attuali!`)) {
        teamsData = data.teams;
        matchesData = data.matches;
        saveData();
        renderAll();
        showToast('Backup importato con successo!', 'success');
      }
    } catch (err) {
      showToast('Errore nell\'importazione: ' + err.message, 'error');
    }
  };
  
  input.click();
}

function resetData() {
  if (!isAdmin) {
    showAdminModal(resetData);
    return;
  }
  
  if (confirm('ATTENZIONE: Vuoi resettare TUTTI i dati?\n\nQuesta azione √® irreversibile!\n\nDigita "RESET" per confermare:')) {
    const confirmation = prompt('Digita RESET per confermare:');
    if (confirmation === 'RESET') {
      localStorage.removeItem('teamsData');
      localStorage.removeItem('matchesData');
      localStorage.removeItem('campionatoData');
      teamsData = [];
      matchesData = [];
      
      if (isFirebaseConnected && databaseRef) {
        databaseRef.remove().catch(err => console.error('Errore Firebase reset:', err));
      }
      
      renderAll();
      showToast('Dati resettati completamente!', 'success');
    } else {
      showToast('Reset annullato', 'info');
    }
  }
}

// ================ FUNZIONI INTERNE ================
function getRoleIcon(role) {
  if (!role) return 'üë§';
  if (role.includes('Capitano')) return '‚≠ê';
  if (role.includes('Portiere')) return 'üß§';
  if (role.includes('Giocatore')) return '‚öΩ';
  return 'üë§';
}

function updateUserBadge() {
  const userBadge = document.getElementById('userBadge');
  if (userBadge) {
    userBadge.innerHTML = `
      <span>${currentUserIcon}</span>
      <span>${currentUser}</span>
      <span class="user-role">${currentUserRole}</span>
    `;
  }
}

function performLogout() {
  currentUser = null;
  currentUserRole = "Giocatore";
  currentUserIcon = "üë§";
  isAdmin = false;
  passwordFieldShown = false;
  
  localStorage.removeItem('currentUser');
  localStorage.removeItem('isAdmin');
  localStorage.removeItem('currentUserRole');
  localStorage.removeItem('currentUserIcon');
  
  if (syncInterval) {
    clearInterval(syncInterval);
    syncInterval = null;
  }
  
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  
  const usernameInput = document.getElementById('loginUsername');
  const passwordInput = document.getElementById('loginPassword');
  usernameInput.value = '';
  passwordInput.value = '';
  passwordInput.style.display = 'none';
  
  usernameInput.focus();
  
  showToast('Logout effettuato! Arrivederci üëã', 'info');
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  
  const icons = {
    info: '‚ÑπÔ∏è',
    success: '‚úÖ',
    warning: '‚ö†Ô∏è',
    error: '‚ùå'
  };
  
  toast.innerHTML = `
    <div class="toast-icon">${icons[type] || icons.info}</div>
    <div class="toast-message">${message}</div>
    <button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    if (toast.parentElement) {
      toast.remove();
    }
  }, 5000);
}

function showAdminModal(actionCallback) {
  pendingAdminAction = actionCallback;
  document.getElementById('adminModal').style.display = 'flex';
  document.getElementById('adminPasswordInput').focus();
}

function toggleAdminFunctions() {
  const isUserAdmin = isAdmin || (currentUser && ADMIN_USERS.includes(currentUser));
  
  const createTeamCard = document.getElementById('createTeamCard');
  if (createTeamCard) {
    createTeamCard.style.display = isUserAdmin ? 'block' : 'none';
  }
  
  const createMatchCard = document.getElementById('createMatchCard');
  if (createMatchCard) {
    createMatchCard.style.display = isUserAdmin ? 'block' : 'none';
  }
  
  const backupCard = document.getElementById('backupCard');
  const backupUserView = document.getElementById('backupUserView');
  if (backupCard && backupUserView) {
    backupCard.style.display = isUserAdmin ? 'block' : 'none';
    backupUserView.style.display = isUserAdmin ? 'none' : 'block';
  }
}

// ================ GESTIONE DATI ================
function saveData() {
  saveDataToFirebase();
}

function saveLocalData() {
  localStorage.setItem('teamsData', JSON.stringify(teamsData));
  localStorage.setItem('matchesData', JSON.stringify(matchesData));
  
  const data = {
    teams: teamsData,
    matches: matchesData,
    lastUpdate: Date.now(),
    lastUser: currentUser,
    lastUserRole: currentUserRole
  };
  localStorage.setItem('campionatoData', JSON.stringify(data));
  lastUpdateTime = data.lastUpdate;
}

function loadLocalData() {
  try {
    const savedFull = localStorage.getItem('campionatoData');
    if (savedFull) {
      const fullData = JSON.parse(savedFull);
      teamsData = fullData.teams || [];
      matchesData = fullData.matches || [];
      lastUpdateTime = fullData.lastUpdate || 0;
      return;
    }
    
    const savedTeams = localStorage.getItem('teamsData');
    const savedMatches = localStorage.getItem('matchesData');
    
    if (savedTeams && savedMatches) {
      teamsData = JSON.parse(savedTeams) || [];
      matchesData = JSON.parse(savedMatches) || [];
      return;
    }
    
    teamsData = [];
    matchesData = [];
    
  } catch (e) {
    console.error('Errore caricamento dati locali:', e);
    showToast('Errore nel caricamento dati locali', 'error');
    teamsData = [];
    matchesData = [];
  }
}

function updateSyncStatus(text, success = true) {
  const syncEl = document.getElementById('syncStatus');
  const syncText = document.getElementById('syncText');
  const syncIcon = document.getElementById('syncIcon');
  
  syncText.textContent = text;
  syncEl.className = success ? 'sync-status' : 'sync-status error';
  syncEl.style.display = 'flex';
  
  clearTimeout(syncEl.hideTimeout);
  syncEl.hideTimeout = setTimeout(() => {
    syncEl.style.display = 'none';
  }, 3000);
}

// ================ GESTIONE SQUADRE ================
function initPalette() {
  const palette = document.getElementById('palette');
  palette.innerHTML = '';
  
  COLORS.forEach(color => {
    const div = document.createElement('div');
    div.className = 'colorPick';
    div.style.background = color;
    if (color === selectedColor) div.classList.add('active');
    div.onclick = () => {
      selectedColor = color;
      document.querySelectorAll('.colorPick').forEach(x => x.classList.remove('active'));
      div.classList.add('active');
    };
    palette.appendChild(div);
  });
}

function addPlayer(teamId) {
  if (!isAdmin) {
    showAdminModal(() => addPlayer(teamId));
    return;
  }
  
  const name = document.getElementById(`p_${teamId}`).value.trim();
  const role = document.getElementById(`r_${teamId}`).value;
  
  if (!name) {
    showToast('Inserisci il nome del giocatore', 'warning');
    return;
  }
  
  const team = teamsData.find(t => t.id === teamId);
  
  for (const t of teamsData) {
    if (t.players.find(p => p.name.toLowerCase() === name.toLowerCase())) {
      showToast(`Il giocatore "${name}" √® gi√† registrato in un'altra squadra!`, 'error');
      return;
    }
  }
  
  team.players.push({
    id: Date.now(),
    name,
    role,
    gol: 0,
    assist: 0,
    giallo: 0,
    rosso: 0,
    presenze: 0,
    addedBy: currentUser
  });
  
  renderTeams();
  saveData();
  showToast(`Giocatore "${name}" aggiunto!`, 'success');
  document.getElementById(`p_${teamId}`).value = '';
}

function editTeam(teamId) {
  if (!isAdmin) {
    showAdminModal(() => editTeam(teamId));
    return;
  }
  
  const team = teamsData.find(t => t.id === teamId);
  const newName = prompt('Nuovo nome squadra:', team.name);
  
  if (newName && newName.trim() && newName !== team.name) {
    if (teamsData.find(t => t.name.toLowerCase() === newName.toLowerCase() && t.id !== teamId)) {
      showToast('Nome gi√† utilizzato', 'error');
      return;
    }
    team.name = newName.trim();
    saveData();
    renderAll();
    showToast('Squadra modificata!', 'success');
  }
}

function deleteTeam(teamId) {
  if (!isAdmin) {
    showAdminModal(() => deleteTeam(teamId));
    return;
  }
  
  if (!confirm('Eliminare questa squadra e tutti i suoi giocatori?\nQuesta azione √® irreversibile!')) return;
  
  teamsData = teamsData.filter(t => t.id !== teamId);
  saveData();
  renderAll();
  showToast('Squadra eliminata!', 'success');
}

function renderTeams() {
  const teamsDiv = document.getElementById('teams');
  const homeSelect = document.getElementById('homeTeam');
  const awaySelect = document.getElementById('awayTeam');
  
  teamsDiv.innerHTML = '';
  homeSelect.innerHTML = '<option value="">Scegli squadra casa</option>';
  awaySelect.innerHTML = '<option value="">Scegli squadra ospite</option>';
  
  if (teamsData.length === 0) {
    teamsDiv.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üë•</div>
        <div class="empty-text">Nessuna squadra creata<br>Crea la prima squadra!</div>
      </div>
    `;
    return;
  }
  
  teamsData.forEach(team => {
    const teamCard = document.createElement('div');
    teamCard.className = 'teamCard';
    teamCard.style.borderLeftColor = team.color;
    
    let playersHTML = '';
    team.players.forEach(player => {
      playersHTML += `
        <div class="player" style="border-left-color: ${team.color}">
          <div class="player-info">
            <div class="player-name">${player.name}</div>
            <div class="player-role">${player.role}</div>
          </div>
          <div class="player-stats">
            <div class="stat-bubble">‚öΩ ${player.gol || 0}</div>
            <div class="stat-bubble">üÖ∞Ô∏è ${player.assist || 0}</div>
          </div>
        </div>
      `;
    });
    
    const adminButtons = isAdmin ? `
      <div class="match-actions">
        <button class="secondary" onclick="editTeam(${team.id})">‚úèÔ∏è Modifica</button>
        <button class="danger" onclick="deleteTeam(${team.id})">üóëÔ∏è Elimina</button>
      </div>
    ` : '';
    
    teamCard.innerHTML = `
      <h3>
        <span class="team-color" style="background: ${team.color}"></span>
        ${team.name}
      </h3>
      ${isAdmin ? `
      <div style="margin: 20px 0">
        <input placeholder="Nome giocatore" id="p_${team.id}">
        <select id="r_${team.id}">
          <option value="Giocatore">Giocatore</option>
          <option value="Capitano">Capitano</option>
          <option value="Portiere">Portiere</option>
        </select>
        <button onclick="addPlayer(${team.id})">‚ûï Aggiungi Giocatore</button>
      </div>
      ` : ''}
      <div id="list_${team.id}">
        ${playersHTML || '<div class="empty-text">Nessun giocatore</div>'}
      </div>
      ${adminButtons}
      <div style="font-size: 11px; color: var(--muted); margin-top: 15px; text-align: right">
        Creata da ${team.createdBy}
      </div>
    `;
    
    teamsDiv.appendChild(teamCard);
    homeSelect.innerHTML += `<option value="${team.name}">${team.name}</option>`;
    awaySelect.innerHTML += `<option value="${team.name}">${team.name}</option>`;
  });
  
  initPalette();
}

// ================ GESTIONE PARTITE ================
function renderMatches() {
  const matchesDiv = document.getElementById('matches');
  matchesDiv.innerHTML = '';
  
  if (matchesData.length === 0) {
    matchesDiv.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üìÖ</div>
        <div class="empty-text">Nessuna partita programmata<br>Crea la prima partita!</div>
      </div>
    `;
    return;
  }
  
  matchesData.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  matchesData.forEach(match => {
    const homeTeam = teamsData.find(t => t.name === match.home);
    const awayTeam = teamsData.find(t => t.name === match.away);
    
    const matchCard = document.createElement('div');
    matchCard.className = 'match-card';
    
    let golHome = match.scoreHome || 0;
    let golAway = match.scoreAway || 0;
    
    golHome = Math.max(0, golHome);
    golAway = Math.max(0, golAway);
    
    const adminActions = isAdmin ? `
      <div class="match-actions">
        <button onclick="openTabellino(${match.id})">üìã GESTISCI</button>
        <button class="secondary" onclick="deleteMatch(${match.id})">üóëÔ∏è ELIMINA</button>
      </div>
    ` : `
      <div class="match-actions">
        <button onclick="openTabellino(${match.id})">üìã VISUALIZZA</button>
      </div>
    `;
    
    matchCard.innerHTML = `
      <div class="match-header">
        <div class="match-date">
          ${new Date(match.date).toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short' })} ${match.time}
        </div>
        <div class="match-creator">${match.createdBy}</div>
      </div>
      
      <div class="match-teams">
        <div class="team-display">
          <div class="team-badge" style="background: ${homeTeam?.color || '#333'}">${match.home.charAt(0)}</div>
          <div class="team-name">${match.home}</div>
        </div>
        
        <div class="vs-divider">VS</div>
        
        <div class="team-display">
          <div class="team-badge" style="background: ${awayTeam?.color || '#333'}">${match.away.charAt(0)}</div>
          <div class="team-name">${match.away}</div>
        </div>
      </div>
      
      <div class="match-score">
        <span style="color: ${homeTeam?.color || '#fff'}">${golHome}</span>
        <span style="font-size: 24px; color: var(--muted)">-</span>
        <span style="color: ${awayTeam?.color || '#fff'}">${golAway}</span>
      </div>
      
      ${adminActions}
      
      <div style="display: flex; justify-content: center; margin-top: 15px">
        <span class="status-badge ${match.completed ? 'completed' : 'pending'}">
          ${match.completed ? '‚úÖ COMPLETATA' : '‚è≥ DA GIOCARE'}
        </span>
      </div>
    `;
    
    matchesDiv.appendChild(matchCard);
  });
}

function deleteMatch(matchId) {
  if (!isAdmin) {
    showAdminModal(() => deleteMatch(matchId));
    return;
  }
  
  if (!confirm('Eliminare questa partita?\nTutti gli eventi saranno rimossi.')) return;
  
  matchesData = matchesData.filter(m => m.id !== matchId);
  saveData();
  renderMatches();
  renderClassifica();
  renderStats();
  showToast('Partita eliminata!', 'success');
}

// ================ TABELLINO ================
function openTabellino(matchId) {
  const match = matchesData.find(m => m.id === matchId);
  if (!match) return;
  
  const homeTeam = teamsData.find(t => t.name === match.home);
  const awayTeam = teamsData.find(t => t.name === match.away);
  
  const tabellino = document.getElementById('tabellino');
  
  const adminControls = isAdmin ? `
    <div style="background: rgba(0, 212, 170, 0.05); padding: 25px; border-radius: 18px; margin: 25px 0">
      <div style="text-align: center; font-size: 14px; color: var(--muted); margin-bottom: 20px; font-weight: 700">
        INSERISCI RISULTATO FINALE
      </div>
      <div class="score-input-container">
        <div class="score-input">
          <input type="number" id="scoreHome" value="${match.scoreHome}" min="0" max="99" onchange="updateMatchScore(${match.id})">
          <div class="score-label" style="color: ${homeTeam?.color || '#fff'}">${match.home}</div>
        </div>
        <div class="score-divider">-</div>
        <div class="score-input">
          <input type="number" id="scoreAway" value="${match.scoreAway}" min="0" max="99" onchange="updateMatchScore(${match.id})">
          <div class="score-label" style="color: ${awayTeam?.color || '#fff'}">${match.away}</div>
        </div>
      </div>
    </div>
    
    <div class="match-actions">
      <button onclick="toggleMatchCompletion(${match.id})">
        ${match.completed ? '‚Ü©Ô∏è ANNULLA COMPLETAMENTO' : '‚úÖ SEGNA COME COMPLETATA'}
      </button>
      <button class="secondary" onclick="recalculateStats(${match.id})">üîÑ RICALCOLA</button>
    </div>
    
    <div style="margin: 30px 0; border-top: 2px solid rgba(136, 146, 176, 0.1); padding-top: 30px">
      <h4 style="margin-bottom: 20px">‚ûï AGGIUNGI EVENTO</h4>
      <select id="evPlayer"></select>
      <select id="evType">
        <option value="gol">‚öΩ Gol</option>
        <option value="assist">üÖ∞Ô∏è Assist</option>
        <option value="giallo">üü® Giallo</option>
        <option value="rosso">üü• Rosso</option>
      </select>
      <div style="display: flex; gap: 15px; margin-top: 15px">
        <input type="number" id="evQty" value="1" min="-10" max="10" style="flex: 2">
        <button onclick="addEvent(${match.id})" style="flex: 1">‚ûï AGGIUNGI</button>
      </div>
      <div style="font-size: 11px; color: var(--muted); margin-top: 10px">
        Usa numeri negativi per correggere errori
      </div>
    </div>
  ` : '';
  
  tabellino.style.display = 'block';
  tabellino.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px">
      <h3>üìã ${match.home} vs ${match.away}</h3>
      <button class="secondary" onclick="closeTabellino()">‚úï CHIUDI</button>
    </div>
    
    <div style="background: rgba(136, 146, 176, 0.05); padding: 20px; border-radius: 16px; margin: 20px 0">
      <div style="display: flex; justify-content: space-around; text-align: center">
        <div>
          <div style="font-size: 14px; color: var(--muted)">CASA</div>
          <div style="font-size: 24px; font-weight: 900; color: ${homeTeam?.color || '#fff'}">${match.home}</div>
          <div style="font-size: 48px; font-weight: 900; color: ${homeTeam?.color || '#fff'}">${match.scoreHome}</div>
        </div>
        <div style="font-size: 36px; color: var(--muted); align-self: center">-</div>
        <div>
          <div style="font-size: 14px; color: var(--muted)">OSPITE</div>
          <div style="font-size: 24px; font-weight: 900; color: ${awayTeam?.color || '#fff'}">${match.away}</div>
          <div style="font-size: 48px; font-weight: 900; color: ${awayTeam?.color || '#fff'}">${match.scoreAway}</div>
        </div>
      </div>
    </div>
    
    ${adminControls}
    
    <h4 style="margin-bottom: 20px">üìù EVENTI PARTITA (${match.events.length})</h4>
    <div id="evList"></div>
  `;
  
  if (isAdmin) {
    loadPlayersForMatch(match);
  }
  renderEvents(match.id);
  tabellino.scrollIntoView({ behavior: 'smooth' });
}

function closeTabellino() {
  document.getElementById('tabellino').style.display = 'none';
}

function updateMatchScore(matchId) {
  if (!isAdmin) {
    showAdminModal(() => updateMatchScore(matchId));
    return;
  }
  
  const match = matchesData.find(m => m.id === matchId);
  const scoreHome = parseInt(document.getElementById('scoreHome').value) || 0;
  const scoreAway = parseInt(document.getElementById('scoreAway').value) || 0;
  
  match.scoreHome = Math.max(0, scoreHome);
  match.scoreAway = Math.max(0, scoreAway);
  
  saveData();
  renderMatches();
  renderClassifica();
  showToast('Risultato aggiornato!', 'success');
}

function toggleMatchCompletion(matchId) {
  if (!isAdmin) {
    showAdminModal(() => toggleMatchCompletion(matchId));
    return;
  }
  
  const match = matchesData.find(m => m.id === matchId);
  match.completed = !match.completed;
  
  if (match.completed) {
    match.completedBy = currentUser;
    match.completedAt = new Date().toLocaleString();
    
    const homeTeam = teamsData.find(t => t.name === match.home);
    const awayTeam = teamsData.find(t => t.name === match.away);
    
    [homeTeam, awayTeam].forEach(team => {
      if (team) {
        team.players.forEach(player => {
          player.presenze = (player.presenze || 0) + 1;
        });
      }
    });
  } else {
    const homeTeam = teamsData.find(t => t.name === match.home);
    const awayTeam = teamsData.find(t => t.name === match.away);
    
    [homeTeam, awayTeam].forEach(team => {
      if (team) {
        team.players.forEach(player => {
          player.presenze = Math.max(0, (player.presenze || 0) - 1);
        });
      }
    });
  }
  
  saveData();
  renderMatches();
  renderClassifica();
  renderStats();
  renderMyScore();
  
  openTabellino(matchId);
  showToast(match.completed ? 'Partita completata!' : 'Completamento annullato!', 'success');
}

function recalculateStats(matchId) {
  if (!isAdmin) {
    showAdminModal(() => recalculateStats(matchId));
    return;
  }
  
  const match = matchesData.find(m => m.id === matchId);
  
  const homeTeam = teamsData.find(t => t.name === match.home);
  const awayTeam = teamsData.find(t => t.name === match.away);
  
  [homeTeam, awayTeam].forEach(team => {
    if (team) {
      team.players.forEach(player => {
        player.gol = 0;
        player.assist = 0;
        player.giallo = 0;
        player.rosso = 0;
      });
    }
  });
  
  matchesData.forEach(m => {
    m.events.forEach(e => {
      const t = teamsData.find(team => team.name === e.team);
      if (t) {
        const p = t.players.find(player => player.name === e.player);
        if (p) {
          if (e.type === 'gol') p.gol = (p.gol || 0) + e.qty;
          if (e.type === 'assist') p.assist = (p.assist || 0) + e.qty;
          if (e.type === 'giallo') p.giallo = (p.giallo || 0) + e.qty;
          if (e.type === 'rosso') p.rosso = (p.rosso || 0) + e.qty;
        }
      }
    });
  });
  
  saveData();
  renderAll();
  showToast('Statistiche ricalcolate!', 'success');
}

function loadPlayersForMatch(match) {
  const select = document.getElementById('evPlayer');
  select.innerHTML = '<option value="">Seleziona giocatore</option>';
  
  [match.home, match.away].forEach(teamName => {
    const team = teamsData.find(t => t.name === teamName);
    if (team) {
      const group = document.createElement('optgroup');
      group.label = teamName;
      
      team.players.forEach(player => {
        const option = document.createElement('option');
        option.value = `${player.name}|${teamName}`;
        option.textContent = `${player.name} (${player.role})`;
        group.appendChild(option);
      });
      
      select.appendChild(group);
    }
  });
}

function addEvent(matchId) {
  if (!isAdmin) {
    showAdminModal(() => addEvent(matchId));
    return;
  }
  
  const [player, team] = document.getElementById('evPlayer').value.split('|');
  const type = document.getElementById('evType').value;
  let qty = parseInt(document.getElementById('evQty').value) || 0;
  
  if (!player || !team) {
    showToast('Seleziona un giocatore', 'warning');
    return;
  }
  
  if (qty === 0) {
    showToast('Inserisci una quantit√†', 'warning');
    return;
  }
  
  const match = matchesData.find(m => m.id === matchId);
  
  match.events.push({
    id: Date.now(),
    player,
    team,
    type,
    qty,
    addedBy: currentUser,
    timestamp: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
  });
  
  const t = teamsData.find(t => t.name === team);
  if (t) {
    const p = t.players.find(p => p.name === player);
    if (p) {
      if (type === 'gol') p.gol = Math.max(0, (p.gol || 0) + qty);
      if (type === 'assist') p.assist = Math.max(0, (p.assist || 0) + qty);
      if (type === 'giallo') p.giallo = Math.max(0, (p.giallo || 0) + qty);
      if (type === 'rosso') p.rosso = Math.max(0, (p.rosso || 0) + qty);
    }
  }
  
  if (type === 'gol') {
    if (team === match.home) {
      match.scoreHome = Math.max(0, (match.scoreHome || 0) + qty);
    } else if (team === match.away) {
      match.scoreAway = Math.max(0, (match.scoreAway || 0) + qty);
    }
  }
  
  renderEvents(matchId);
  saveData();
  renderMatches();
  renderClassifica();
  renderStats();
  
  document.getElementById('evPlayer').selectedIndex = 0;
  document.getElementById('evQty').value = qty > 0 ? 1 : -1;
  
  showToast(`Evento aggiunto: ${type} x${Math.abs(qty)}`, 'success');
}

function renderEvents(matchId) {
  const match = matchesData.find(m => m.id === matchId);
  const list = document.getElementById('evList');
  list.innerHTML = '';
  
  if (match.events.length === 0) {
    list.innerHTML = `
      <div class="empty-state" style="padding: 40px 20px">
        <div class="empty-icon">üìù</div>
        <div class="empty-text">Nessun evento registrato</div>
      </div>
    `;
    return;
  }
  
  match.events.sort((a, b) => b.id - a.id).forEach(event => {
    const team = teamsData.find(t => t.name === event.team);
    const eventDiv = document.createElement('div');
    eventDiv.className = 'event';
    eventDiv.style.borderLeftColor = team?.color || '#ccc';
    
    const icon = event.type === 'gol' ? '‚öΩ' : 
                 event.type === 'assist' ? 'üÖ∞Ô∏è' : 
                 event.type === 'giallo' ? 'üü®' : 'üü•';
    
    const qtyColor = event.qty < 0 ? 'var(--danger)' : 'var(--success)';
    
    eventDiv.innerHTML = `
      <div class="event-info">
        <div class="event-player">${event.player}</div>
        <div class="event-details">
          <span>${icon} ${event.type}</span>
          <span style="color: ${qtyColor}; font-weight: 700">${event.qty > 0 ? '+' : ''}${event.qty}</span>
          <span style="opacity: 0.7">‚Ä¢</span>
          <span>${event.team}</span>
        </div>
      </div>
      <div class="event-meta">
        <div class="event-admin">${event.addedBy}</div>
        <div class="event-time">${event.timestamp}</div>
        ${isAdmin ? `
        <button onclick="removeEvent(${match.id}, ${event.id})" 
                style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 12px; margin-top: 5px">
          ‚úï Rimuovi
        </button>
        ` : ''}
      </div>
    `;
    
    list.appendChild(eventDiv);
  });
}

function removeEvent(matchId, eventId) {
  if (!isAdmin) {
    showAdminModal(() => removeEvent(matchId, eventId));
    return;
  }
  
  if (!confirm('Rimuovere questo evento?')) return;
  
  const match = matchesData.find(m => m.id === matchId);
  const eventIndex = match.events.findIndex(e => e.id === eventId);
  if (eventIndex === -1) return;
  
  const event = match.events[eventIndex];
  
  const t = teamsData.find(team => team.name === event.team);
  if (t) {
    const p = t.players.find(player => player.name === event.player);
    if (p) {
      if (event.type === 'gol') p.gol = Math.max(0, (p.gol || 0) - event.qty);
      if (event.type === 'assist') p.assist = Math.max(0, (p.assist || 0) - event.qty);
      if (event.type === 'giallo') p.giallo = Math.max(0, (p.giallo || 0) - event.qty);
      if (event.type === 'rosso') p.rosso = Math.max(0, (p.rosso || 0) - event.qty);
    }
  }
  
  if (event.type === 'gol') {
    if (event.team === match.home) {
      match.scoreHome = Math.max(0, (match.scoreHome || 0) - event.qty);
    } else if (event.team === match.away) {
      match.scoreAway = Math.max(0, (match.scoreAway || 0) - event.qty);
    }
  }
  
  match.events.splice(eventIndex, 1);
  
  saveData();
  renderEvents(matchId);
  renderMatches();
  renderClassifica();
  renderStats();
  
  showToast('Evento rimosso!', 'success');
}

// ================ CLASSIFICA ================
function renderClassifica() {
  const table = document.getElementById('table');
  table.innerHTML = '';
  
  if (teamsData.length === 0) {
    table.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üèÜ</div>
        <div class="empty-text">Nessuna squadra in classifica<br>Crea le squadre e le partite!</div>
      </div>
    `;
    return;
  }
  
  const standings = teamsData.map(team => {
    let punti = 0, giocate = 0, vinte = 0, pareggiate = 0, perse = 0, gf = 0, gs = 0;
    
    matchesData.filter(m => m.completed).forEach(match => {
      if (match.home === team.name) {
        giocate++;
        gf += match.scoreHome;
        gs += match.scoreAway;
        if (match.scoreHome > match.scoreAway) { punti += 3; vinte++; }
        else if (match.scoreHome === match.scoreAway) { punti += 1; pareggiate++; }
        else perse++;
      }
      if (match.away === team.name) {
        giocate++;
        gf += match.scoreAway;
        gs += match.scoreHome;
        if (match.scoreAway > match.scoreHome) { punti += 3; vinte++; }
        else if (match.scoreAway === match.scoreHome) { punti += 1; pareggiate++; }
        else perse++;
      }
    });
    
    return {
      team,
      punti,
      giocate,
      vinte,
      pareggiate,
      perse,
      gf,
      gs,
      dr: gf - gs
    };
  });
  
  standings.sort((a, b) => b.punti - a.punti || b.dr - a.dr || b.gf - a.gf);
  
  standings.forEach((standing, index) => {
    const row = document.createElement('div');
    row.className = 'standing-row';
    row.style.borderLeftColor = standing.team.color;
    
    row.innerHTML = `
      <div class="standing-pos">${index + 1}</div>
      <div class="standing-team">
        <div class="standing-team-name">${standing.team.name}</div>
      </div>
      <div class="standing-stats">
        <div class="standing-stat">${standing.giocate}</div>
        <div class="standing-stat">${standing.vinte}</div>
        <div class="standing-stat">${standing.pareggiate}</div>
        <div class="standing-stat">${standing.perse}</div>
        <div class="standing-stat">${standing.gf}</div>
        <div class="standing-stat">${standing.gs}</div>
        <div class="standing-points">${standing.punti}</div>
      </div>
    `;
    
    table.appendChild(row);
  });
}

// ================ STATISTICHE ================
function renderStats() {
  let allPlayers = [];
  teamsData.forEach(t => {
    t.players.forEach(p => {
      allPlayers.push({
        team: t.name,
        teamColor: t.color,
        ...p
      });
    });
  });
  
  renderTopList('topScorers', allPlayers, 'gol', '‚öΩ', 'Marcatori');
  renderTopList('topAssists', allPlayers, 'assist', 'üÖ∞Ô∏è', 'Assist');
  renderTopList('topYellows', allPlayers, 'giallo', 'üü®', 'Gialli', '#fdd835');
  renderTopList('topReds', allPlayers, 'rosso', 'üü•', 'Rossi', '#e63946');
}

function renderTopList(elementId, players, statKey, icon, label, color = null) {
  const element = document.getElementById(elementId);
  element.innerHTML = '';
  
  const sorted = [...players].sort((a, b) => (b[statKey] || 0) - (a[statKey] || 0));
  const topPlayers = sorted.slice(0, 10).filter(p => (p[statKey] || 0) > 0);
  
  if (topPlayers.length === 0) {
    element.innerHTML = `
      <div style="text-align: center; padding: 30px; color: var(--muted); font-size: 14px">
        Nessun dato disponibile
      </div>
    `;
    return;
  }
  
  topPlayers.forEach((player, index) => {
    const playerDiv = document.createElement('div');
    playerDiv.className = 'player';
    playerDiv.style.borderLeftColor = color || player.teamColor;
    
    playerDiv.innerHTML = `
      <div class="player-info">
        <div class="player-name">
          <span style="font-weight: 900; color: var(--accent); margin-right: 8px">${index + 1}.</span>
          ${player.name}
        </div>
        <div class="player-role">${player.team} ‚Ä¢ ${player.role}</div>
      </div>
      <div class="player-stats">
        <div class="stat-bubble" style="${color ? `background: ${color}20; color: ${color}` : ''}">
          ${icon} ${player[statKey] || 0}
        </div>
      </div>
    `;
    
    element.appendChild(playerDiv);
  });
}

// ================ IL MIO SCORE ================
function renderMyScore() {
  if (!currentUser) return;
  
  let myGoals = 0, myAssists = 0, myYellows = 0, myReds = 0;
  
  teamsData.forEach(team => {
    team.players.filter(p => p.name.toLowerCase() === currentUser.toLowerCase()).forEach(player => {
      myGoals += player.gol || 0;
      myAssists += player.assist || 0;
      myYellows += player.giallo || 0;
      myReds += player.rosso || 0;
    });
  });
  
  const statsDiv = document.getElementById('myScoreStats');
  statsDiv.innerHTML = `
    <div class="my-score-stats">
      <div class="my-stat-card">
        <div style="font-size: 14px; color: var(--muted)">Gol Totali</div>
        <div class="my-stat-value">${myGoals}</div>
        <div class="my-stat-label">‚öΩ Gol</div>
      </div>
      <div class="my-stat-card">
        <div style="font-size: 14px; color: var(--muted)">Assist Totali</div>
        <div class="my-stat-value">${myAssists}</div>
        <div class="my-stat-label">üÖ∞Ô∏è Assist</div>
      </div>
      <div class="my-stat-card">
        <div style="font-size: 14px; color: var(--muted)">Cartellini</div>
        <div class="my-stat-value">${myYellows + myReds}</div>
        <div class="my-stat-label">üü®üü• Totali</div>
      </div>
      <div class="my-stat-card">
        <div style="font-size: 14px; color: var(--muted)">Ruolo</div>
        <div class="my-stat-value">${currentUserRole}</div>
        <div class="my-stat-label">${currentUserIcon} ${currentUserRole}</div>
      </div>
    </div>
  `;
  
  const detailsDiv = document.getElementById('myScoreDetails');
  detailsDiv.innerHTML = '';
  
  const myPlayers = [];
  teamsData.forEach(team => {
    team.players.filter(p => p.name.toLowerCase() === currentUser.toLowerCase()).forEach(player => {
      myPlayers.push({ team, ...player });
    });
  });
  
  if (myPlayers.length > 0) {
    const playersCard = document.createElement('div');
    playersCard.className = 'card';
    playersCard.innerHTML = `<h3>üë§ I Miei Dati Giocatore</h3>`;
    
    myPlayers.forEach(playerData => {
      const playerDiv = document.createElement('div');
      playerDiv.className = 'player';
      playerDiv.style.borderLeftColor = playerData.team.color;
      
      playerDiv.innerHTML = `
        <div>
          <div style="font-weight: 700; font-size: 16px">${playerData.name}</div>
          <div style="font-size: 13px; color: var(--muted); margin-top: 4px">
            ${playerData.team.name} ‚Ä¢ ${playerData.role}
          </div>
        </div>
        <div style="text-align: right">
          <div style="display: flex; gap: 15px">
            <div style="text-align: center">
              <div style="font-size: 20px; font-weight: 900">${playerData.gol || 0}</div>
              <div style="font-size: 11px; color: var(--muted)">‚öΩ Gol</div>
            </div>
            <div style="text-align: center">
              <div style="font-size: 20px; font-weight: 900">${playerData.assist || 0}</div>
              <div style="font-size: 11px; color: var(--muted)">üÖ∞Ô∏è Assist</div>
            </div>
          </div>
          <div style="font-size: 11px; color: var(--muted); margin-top: 4px">
            üü®${playerData.giallo || 0} üü•${playerData.rosso || 0} üë•${playerData.presenze || 0}
          </div>
        </div>
      `;
      
      playersCard.appendChild(playerDiv);
    });
    
    detailsDiv.appendChild(playersCard);
  } else if (isAdmin) {
    detailsDiv.innerHTML = `
      <div class="card">
        <h3>üë§ Informazioni Admin</h3>
        <div style="padding: 20px; text-align: center">
          <div style="font-size: 48px; margin-bottom: 20px">üëë</div>
          <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px">${currentUser} (Admin)</div>
          <div style="color: var(--muted); font-size: 14px">
            Hai accesso completo a tutte le funzioni di gestione del campionato
          </div>
        </div>
      </div>
    `;
  }
}

// ================ BACKUP & RIPRISTINO ================
function renderBackup() {
  updateBackupInfo();
}

function updateBackupInfo() {
  let totalPlayers = 0;
  let totalEvents = 0;
  
  teamsData.forEach(t => {
    totalPlayers += t.players.length;
  });
  
  matchesData.forEach(m => {
    totalEvents += m.events.length;
  });
  
  // Per admin
  document.getElementById('backupTeamsCount').textContent = teamsData.length;
  document.getElementById('backupMatchesCount').textContent = matchesData.length;
  document.getElementById('backupPlayersCount').textContent = totalPlayers;
  document.getElementById('backupEventsCount').textContent = totalEvents;
  
  // Per utenti normali
  document.getElementById('userBackupTeamsCount').textContent = teamsData.length;
  document.getElementById('userBackupMatchesCount').textContent = matchesData.length;
  document.getElementById('userBackupPlayersCount').textContent = totalPlayers;
  document.getElementById('userBackupEventsCount').textContent = totalEvents;
}

// ================ RENDER ALL ================
function renderAll() {
  renderTeams();
  renderMatches();
  renderClassifica();
  renderStats();
  renderMyScore();
  renderBackup();
}

// ================ ESPORTA FUNZIONI A WINDOW ================
window.checkLogin = checkLogin;
window.openTab = openTab;
window.logout = logout;
window.addTeam = addTeam;
window.addMatch = addMatch;
window.closeAdminModal = closeAdminModal;
window.verifyAdmin = verifyAdmin;
window.exportData = exportData;
window.importData = importData;
window.resetData = resetData;
window.addPlayer = addPlayer;
window.editTeam = editTeam;
window.deleteTeam = deleteTeam;
window.deleteMatch = deleteMatch;
window.openTabellino = openTabellino;
window.closeTabellino = closeTabellino;
window.updateMatchScore = updateMatchScore;
window.toggleMatchCompletion = toggleMatchCompletion;
window.recalculateStats = recalculateStats;
window.addEvent = addEvent;
window.removeEvent = removeEvent;

// ================ INIZIALIZZAZIONE ================
document.addEventListener('DOMContentLoaded', async function() {
  const today = new Date().toISOString().split('T')[0];
  if (document.getElementById('matchDate')) {
    document.getElementById('matchDate').value = today;
    document.getElementById('matchDate').min = today;
  }
  
  initPalette();
  
  loadLocalData();
  
  const savedUser = localStorage.getItem('currentUser');
  const savedAdmin = localStorage.getItem('isAdmin') === 'true';
  
  if (savedUser) {
    currentUser = savedUser;
    isAdmin = savedAdmin;
    currentUserRole = localStorage.getItem('currentUserRole') || "Giocatore";
    currentUserIcon = localStorage.getItem('currentUserIcon') || "üë§";
    
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    
    updateUserBadge();
    toggleAdminFunctions();
    
    renderAll();
    
    // Inizializza Firebase
    await initializeFirebase();
    initFirebaseSync();
  } else {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
    document.getElementById('loginUsername').focus();
  }
});
</script>
</body>
</html>